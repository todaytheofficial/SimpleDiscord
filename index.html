<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeoCord Messenger</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="style.css"> 
</head>
<body class="theme-dark">

    <div id="app-container">
        <div id="friends-channels-panel">
            <input type="text" id="friend-search-input" placeholder="Search for friends or start a DM..." />
            
            <div id="add-friend-block" style="margin-bottom: 15px;">
                <input type="text" id="add-friend-input" class="modal-input" placeholder="Username to add" style="width: 100%; margin: 0 0 5px 0;" />
                <button onclick="sendFriendRequestUI()" class="modal-button" style="width: 100%; padding: 8px; margin: 0; font-size: 14px;">
                    Send Friend Request <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            <div class="friend-list-header">
                <span id="tab-friends" class="active" onclick="showFriendList('friends')">
                    <i class="fas fa-user-friends"></i>Friends (<span id="friends-count">0</span>)
                </span>
                <span id="tab-requests" onclick="showFriendList('requests')">
                    <i class="fas fa-bell"></i>Requests (<span id="requests-count">0</span>)
                </span>
            </div>

            <div id="dm-section">
                </div>

            <div id="user-profile-bar" onclick="openSettingsModal()">
                <img id="profile-avatar" class="avatar" src="/img/anon_blue.png" alt="Avatar">
                <div style="margin-right: auto;">
                    <strong id="profile-username">Loading...</strong>
                </div>
                <div class="status-indicator"></div>
            </div>
        </div>

        <div id="chat-area">
            <header style="display: flex; align-items: center;">
                 <button id="mobile-back-button" onclick="goBackToFriends()" style="display: none; background: none; border: none; color: var(--text-main); font-size: 1.2em; margin-right: 15px; cursor: pointer;">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <span id="chat-header">Select a friend to chat</span>
            </header>
            
            <div id="messages-container">
                <p style="text-align: center; color: var(--text-sub); margin-top: 50px;">Please log in to continue.</p>
            </div>

            <form id="form">
                <div id="form-inner">
                    <input id="input" autocomplete="off" placeholder="Send a message..." disabled />
                    <button>Send</button>
                </div>
            </form>
        </div>
    </div>

    <div id="auth-modal" class="modal" style="display: block;">
        <div class="modal-content">
            <span class="close" onclick="closeModal('auth-modal')">&times;</span>
            <h2 id="auth-title" style="text-align: center;">Login</h2>
            <p id="auth-error-message" style="color: var(--danger-color); text-align: center;"></p>

            <form id="auth-form" onsubmit="handleAuth(event)">
                <input type="text" id="auth-username" class="modal-input" placeholder="Username" required>
                <input type="password" id="auth-password" class="modal-input" placeholder="Password" required>
                
                <button id="auth-button" class="modal-button">Login</button>
            </form>
            <div class="auth-switch" onclick="switchAuthMode()">Go to Registration</div>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div style="width: 200px; padding: 30px 0 30px 30px; background-color: var(--bg-tertiary);">
                <h3 style="margin-top: 0; color: var(--text-main); font-weight: 700;">Settings</h3>
                <div id="settings-menu">
                    <div class="setting-item active" data-content="my-account">My Account</div>
                    <div class="setting-item" data-content="appearance">Appearance</div>
                    <div class="setting-item" data-content="admin-panel" style="display: none;">Admin Panel</div>
                    <div class="setting-item logout-item" onclick="handleLogout()">Logout</div>
                </div>
            </div>

            <div id="settings-content" style="flex-grow: 1;">
                <span class="close" onclick="closeModal('settings-modal')">&times;</span>

                <div id="my-account-content" class="setting-page">
                    <h2>My Account</h2>
                    <p style="color: var(--text-sub); margin-bottom: 25px;">Here you can change your username and avatar.</p>
                    
                    <form id="update-profile-form" onsubmit="handleProfileUpdate(event)">
                        <label for="update-username" style="font-size: 13px; color: var(--text-sub); font-weight: 600;">Username</label>
                        <input type="text" id="update-username" class="modal-input" placeholder="New username" style="width: 100%;" required>
                        
                        <label for="update-avatar-file" style="font-size: 13px; color: var(--text-sub); font-weight: 600; margin-top: 15px; display: block;">Avatar</label>
                        <label for="update-avatar-file" class="file-input-container">
                            <i class="fas fa-camera"></i> Select new avatar
                        </label>
                        <input type="file" id="update-avatar-file" accept="image/*" style="display: none;">
                        <p id="update-file-name-display" style="font-size: 12px; color: var(--text-sub);"></p>

                        <button type="submit" class="modal-button">Save Changes</button>
                    </form>

                    <h3 style="color: var(--danger-color); margin-top: 40px;">Danger Zone</h3>
                    <button class="modal-button" style="background-color: var(--danger-color); width: auto;" onclick="confirmDeleteAccount()">Delete Account</button>
                </div>

                <div id="appearance-content" class="setting-page" style="display: none;">
                    <h2>Appearance</h2>
                    <p style="color: var(--text-sub);">Select one of the available themes.</p>
                    
                    <div style="display: flex; gap: 15px; margin-top: 20px;">
                        <div class="theme-option active-theme" data-theme="dark" onclick="setTheme('dark')">
                            <i class="fas fa-moon"></i>
                            Dark
                        </div>
                        <div class="theme-option" data-theme="light" onclick="setTheme('light')">
                            <i class="fas fa-sun"></i>
                            Light
                        </div>
                        <div class="theme-option" data-theme="custom" onclick="setTheme('custom')">
                            <i class="fas fa-palette"></i>
                            Blue
                        </div>
                    </div>
                </div>

                <div id="admin-panel-content" class="setting-page" style="display: none;">
                    <h2>Admin Panel</h2>
                    <p style="color: var(--text-sub);">Execute administrative commands.</p>
                    <form id="admin-form" onsubmit="handleAdminCommand(event)">
                        <label for="admin-command" style="font-size: 13px; color: var(--text-sub); font-weight: 600;">Command (e.g., listusers, block testuser, announce Hello world)</label>
                        <input type="text" id="admin-command-input" class="modal-input" placeholder="Enter command" style="width: 100%;" required>
                        <button type="submit" class="modal-button" style="background-color: var(--danger-color);">Execute</button>
                    </form>
                    <pre id="admin-output" style="background-color: var(--input-bg); padding: 10px; border-radius: 4px; margin-top: 20px; color: var(--text-main); white-space: pre-wrap; font-size: 14px;"></pre>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // --- Configuration ---
        const API_URL = '/';
        const messagesContainer = document.getElementById('messages-container');
        const dmSection = document.getElementById('dm-section');
        const chatHeader = document.getElementById('chat-header');
        
        let socket;
        let authMode = 'login';
        let currentUserId;
        let currentUsername;
        let currentAvatar;
        let currentUserIsAdmin = false;
        let activeChat = { id: 0, isDM: true, friendId: null }; 
        let currentFriends = {}; // { userId: { username, avatar, channelId } }
        let currentRequests = {}; // { userId: { username, avatar } }
        let currentToken = localStorage.getItem('jwtToken');
        
        const mobileMediaQuery = window.matchMedia('(max-width: 800px)');

        // --- Utility Functions ---

        function createElement(tag, className = '', textContent = '') {
            const el = document.createElement(tag);
            if (className) el.className = className;
            if (textContent) el.textContent = textContent;
            return el;
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
            document.getElementById('auth-error-message').textContent = '';
        }

        function openModal(id) {
            document.getElementById(id).style.display = 'block';
        }
        
        function goBackToFriends() {
             document.getElementById('app-container').classList.remove('show-chat');
             document.getElementById('mobile-back-button').style.display = 'none';
        }

        // --- Authentication & Initialization ---

        function switchAuthMode() {
            authMode = authMode === 'login' ? 'register' : 'login';
            document.getElementById('auth-title').textContent = authMode === 'login' ? 'Login' : 'Register';
            document.getElementById('auth-button').textContent = authMode === 'login' ? 'Login' : 'Register';
            document.querySelector('.auth-switch').textContent = authMode === 'login' ? 'Go to Registration' : 'Go to Login';
        }

        async function handleAuth(event) {
            event.preventDefault();
            const username = document.getElementById('auth-username').value;
            const password = document.getElementById('auth-password').value;
            const errorMessage = document.getElementById('auth-error-message');
            errorMessage.textContent = '';
            
            // Using JSON for both login and simplified registration (no file upload)
            const body = { username, password };

            try {
                const endpoint = authMode === 'login' ? '/api/login' : '/api/register';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    body: JSON.stringify(body),
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (response.ok) {
                    if (authMode === 'login') {
                        localStorage.setItem('jwtToken', data.token);
                        currentToken = data.token;
                        initializeUI(data);
                        closeModal('auth-modal');
                    } else {
                        errorMessage.textContent = 'Registration successful! Please log in.';
                        switchAuthMode();
                    }
                } else {
                    errorMessage.textContent = data.message || `Error during ${authMode}.`;
                }
            } catch (error) {
                errorMessage.textContent = `Network error: ${error.message}`;
            }
        }

        function initializeUI(userData) {
            currentUserId = userData.userId;
            currentUsername = userData.username;
            currentAvatar = userData.avatar;
            currentUserIsAdmin = userData.isAdmin;
            
            document.getElementById('profile-username').textContent = currentUsername;
            document.getElementById('profile-avatar').src = currentAvatar;
            document.getElementById('input').disabled = false;
            
            // Show Admin Panel option if admin
            document.querySelector('[data-content="admin-panel"]').style.display = currentUserIsAdmin ? 'block' : 'none';

            connectSocket();
            updateMobileUI(); // Set initial state for mobile view
        }

        function handleLogout() {
            localStorage.removeItem('jwtToken');
            currentToken = null;
            location.reload(); 
        }
        
        function updateMobileUI() {
             // Check if mobile view is active
             const isMobile = mobileMediaQuery.matches;
             
             // Show/hide back button based on whether chat is visible in mobile view
             const isChatVisible = document.getElementById('app-container').classList.contains('show-chat');
             if (isMobile) {
                 document.getElementById('mobile-back-button').style.display = isChatVisible ? 'inline-block' : 'none';
             } else {
                 document.getElementById('mobile-back-button').style.display = 'none';
             }
        }
        
        mobileMediaQuery.addListener(updateMobileUI);


        // --- Chat and Socket Logic ---

        function displayMessage(msg, isHistory = false) {
            const item = createElement('div', 'message');
            
            const avatarImg = createElement('img', 'avatar');
            avatarImg.src = msg.avatar;
            item.appendChild(avatarImg);
            
            const contentDiv = createElement('div', 'message-content');
            
            const header = createElement('div');
            const isAnnouncement = msg.username === 'SYSTEM ANNOUNCEMENT';
            const usernameStyle = isAnnouncement ? 'color: var(--danger-color); font-weight: bold;' : '';
            
            header.innerHTML = `<strong style="${usernameStyle}">${msg.username}</strong> <span class="timestamp">${new Date(msg.timestamp).toLocaleTimeString('en-US')}</span>`;
            contentDiv.appendChild(header);
            
            const text = createElement('p', '', msg.content);
            contentDiv.appendChild(text);
            
            item.appendChild(contentDiv);
            messagesContainer.appendChild(item);
            
            if (!isHistory) {
                scrollToBottom(); 
            }
        }

        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight; 
        }

        function connectSocket() {
            if (socket) { socket.disconnect(); }
            socket = io(API_URL);

            socket.on('connect', () => {
                if (currentToken) {
                    socket.emit('authenticate', currentToken);
                } else {
                    openModal('auth-modal');
                }
            });

            socket.on('initialData', (data) => {
                currentFriends = data.friends.reduce((acc, f) => { acc[f.userId] = f; return acc; }, {});
                currentRequests = data.pendingRequests.reduce((acc, r) => { acc[r.userId] = r; return acc; }, {});
                
                activeChat.id = data.activeChatId;
                if (activeChat.id !== 0) {
                     const friendKeys = Object.keys(currentFriends);
                     for (let friendId of friendKeys) {
                         if (currentFriends[friendId].channelId === activeChat.id) {
                            activeChat.friendId = currentFriends[friendId].userId;
                            chatHeader.textContent = `@${currentFriends[friendId].username}`;
                            break;
                         }
                     }
                } else {
                    chatHeader.textContent = `Select a friend to chat`;
                }
                
                const activeTab = document.querySelector('.friend-list-header span.active').id.replace('tab-', '');
                updateFriendListUI(activeTab);
            });
            
            socket.on('friendAdded', (friendData) => {
                 currentFriends[friendData.userId] = friendData;
                 
                 if (document.getElementById('tab-friends').classList.contains('active')) {
                     updateFriendListUI('friends');
                 } else {
                     document.getElementById('friends-count').textContent = Object.keys(currentFriends).length;
                 }
                 
                 if (activeChat.id === 0) {
                     joinChat(friendData.channelId, friendData.userId, friendData.username);
                 }
            });

            socket.on('newMessage', (msg) => {
                if (msg.channelId === activeChat.id) {
                    displayMessage(msg);
                }
            });

            socket.on('messageHistory', (history) => {
                messagesContainer.innerHTML = ''; 
                if (history.length === 0) {
                     messagesContainer.innerHTML = `<p style="text-align: center; color: var(--text-sub); margin-top: 50px;">Start the conversation!</p>`;
                }
                history.forEach(msg => displayMessage(msg, true)); 
                scrollToBottom(); 
            });

            socket.on('systemAnnouncement', (msg) => {
                displayMessage(msg); 
            });

            socket.on('requestError', (message) => {
                alert(`Error: ${message}`);
            });
            
            socket.on('requestSuccess', (message) => {
                if (document.getElementById('admin-panel-content').style.display !== 'none') {
                     document.getElementById('admin-output').textContent = message;
                } else {
                     console.log('Success:', message);
                }
            });
            
            socket.on('friendRequestReceived', (request) => {
                currentRequests[request.userId] = request;
                 if (document.getElementById('tab-requests').classList.contains('active')) {
                     updateFriendListUI('requests');
                 } else {
                     document.getElementById('requests-count').textContent = Object.keys(currentRequests).length;
                 }
                alert(`New friend request from ${request.username}!`);
            });
            
            socket.on('accountDeleted', () => {
                 alert('Your account has been deleted.');
                 handleLogout();
            });

            socket.on('disconnect', () => {
                console.log('Socket disconnected.');
                if (currentToken) {
                    messagesContainer.innerHTML = `<p style="text-align: center; color: var(--danger-color); margin-top: 50px;">Connection lost. Reconnecting...</p>`;
                }
            });
        }

        // --- Friend List & DM Logic ---
        
        function showFriendList(tab) {
            document.getElementById('tab-friends').classList.remove('active');
            document.getElementById('tab-requests').classList.remove('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
            updateFriendListUI(tab);
        }

        function sendFriendRequestUI() {
            const recipientUsername = document.getElementById('add-friend-input').value.trim();
            if (!recipientUsername) {
                alert('Enter a username!');
                return;
            }
            
            socket.emit('sendFriendRequest', recipientUsername);
            document.getElementById('add-friend-input').value = ''; 
        }

        function updateFriendListUI(tab) {
            dmSection.innerHTML = '';
            document.getElementById('friends-count').textContent = Object.keys(currentFriends).length;
            document.getElementById('requests-count').textContent = Object.keys(currentRequests).length;

            if (tab === 'friends') {
                const friendsArray = Object.values(currentFriends);
                if (friendsArray.length === 0) {
                    dmSection.innerHTML = `<p style="color: var(--text-sub); text-align: center; margin-top: 20px;">No friends. Send a request!</p>`;
                } else {
                    friendsArray.forEach(friend => {
                        const item = createElement('div', 'friend-item');
                        item.setAttribute('data-id', friend.userId);
                        item.onclick = () => joinChat(friend.channelId, friend.userId, friend.username);
                        
                        const isActive = activeChat.id === friend.channelId;
                        if (isActive) item.classList.add('active');
                        
                        item.innerHTML = `
                            <img class="avatar" src="${friend.avatar}" alt="Avatar">
                            <span>${friend.username}</span>
                        `;
                        dmSection.appendChild(item);
                    });
                }
            } else if (tab === 'requests') {
                const requestsArray = Object.values(currentRequests);
                if (requestsArray.length === 0) {
                    dmSection.innerHTML = `<p style="color: var(--text-sub); text-align: center; margin-top: 20px;">No incoming requests.</p>`;
                } else {
                    requestsArray.forEach(request => {
                        const item = createElement('div', 'friend-item');
                        item.style.flexWrap = 'wrap';
                        item.innerHTML = `
                            <img class="avatar" src="${request.avatar}" alt="Avatar">
                            <span style="flex-grow: 1;">${request.username}</span>
                            <button onclick="handleFriendRequest(${request.userId}, 'accept', event)" style="margin-left: 10px; background: var(--online-color); color: white; border: none; padding: 5px 8px; border-radius: 4px; cursor: pointer;"><i class="fas fa-check"></i> Accept</button>
                            <button onclick="handleFriendRequest(${request.userId}, 'reject', event)" style="margin-left: 5px; background: var(--danger-color); color: white; border: none; padding: 5px 8px; border-radius: 4px; cursor: pointer;"><i class="fas fa-times"></i> Reject</button>
                        `;
                        dmSection.appendChild(item);
                    });
                }
            }
        }
        
        function joinChat(channelId, friendId, friendUsername) {
            if (activeChat.id === channelId) return;
            
            // Update active item in the list
            document.querySelectorAll('.friend-item').forEach(el => el.classList.remove('active'));
            const friendItem = document.querySelector(`.friend-item[data-id="${friendId}"]`);
            if (friendItem) friendItem.classList.add('active');
            
            chatHeader.textContent = `@${friendUsername}`;
            activeChat.id = channelId;
            activeChat.friendId = friendId;
            
            socket.emit('joinChat', { newId: channelId, isDM: true });
            
            // --- Mobile adaptation: Show chat ---
            if (mobileMediaQuery.matches) {
                document.getElementById('app-container').classList.add('show-chat');
                document.getElementById('mobile-back-button').style.display = 'inline-block';
            }
        }
        
        function handleFriendRequest(userId, action, event) {
            event.stopPropagation(); 
            socket.emit('handleFriendRequest', { userId: userId, action: action });
            
            delete currentRequests[userId];
            updateFriendListUI('requests');
        }

        // --- Message Submission ---
        document.getElementById('form').onsubmit = function(e) {
            e.preventDefault();
            const input = document.getElementById('input');
            const content = input.value.trim();
            
            if (!content) return;
            if (activeChat.id === 0) {
                alert('Select a friend to send a message!');
                return;
            }
            
            // Check for admin command prefix
            if (content.toLowerCase().startsWith('/admin ') && currentUserIsAdmin) {
                 const command = content.substring(7); 
                 const parts = command.split(' ');
                 const cmd = parts[0].toLowerCase();
                 let targetUsername = null;
                 let message = null;
                 
                 if (cmd === 'block' || cmd === 'unblock') {
                      targetUsername = parts[1];
                 } else if (cmd === 'announce') {
                      message = command.substring(command.toLowerCase().indexOf('announce') + 'announce'.length).trim();
                 }
                 
                 socket.emit('adminCommand', { command: cmd, targetUsername: targetUsername, message: message });
            } else {
                 socket.emit('chat message', { content: content });
            }
            
            input.value = '';
        };

        // --- Settings Logic ---
        
        function openSettingsModal() {
            openModal('settings-modal');
            
            document.getElementById('update-username').value = currentUsername;
            document.getElementById('update-file-name-display').textContent = 'Current avatar: unchanged';

            document.querySelector('.setting-item[data-content="my-account"]').click();
        }

        // Tab switching in settings
        document.querySelectorAll('.setting-item').forEach(item => {
            item.onclick = function() {
                document.querySelectorAll('.setting-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                
                document.querySelectorAll('.setting-page').forEach(page => page.style.display = 'none');
                
                const contentId = item.getAttribute('data-content');
                if (contentId) {
                    document.getElementById(contentId + '-content').style.display = 'block';
                }
            };
        });
        
        // Profile update submission
        async function handleProfileUpdate(event) {
            event.preventDefault();
            const newUsername = document.getElementById('update-username').value;
            const fileInput = document.getElementById('update-avatar-file');
            
            const formData = new FormData();
            formData.append('newUsername', newUsername);
            if (fileInput.files[0]) {
                 formData.append('avatar', fileInput.files[0]);
            }
            
            try {
                const response = await fetch('/api/update-profile', {
                    method: 'POST',
                    body: formData,
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });

                const data = await response.json();

                if (response.ok) {
                    alert('Profile updated! ' + (data.message || ''));
                    socket.emit('authenticate', currentToken);
                    closeModal('settings-modal');
                } else {
                    alert('Profile update error: ' + (data.message || response.statusText));
                }
            } catch (error) {
                alert(`Network error: ${error.message}`);
            }
        }
        
        function confirmDeleteAccount() {
             if (confirm("Are you sure you want to delete your account? This action is irreversible!")) {
                 deleteAccount();
             }
        }
        
        async function deleteAccount() {
             try {
                const response = await fetch('/api/delete-account', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                     alert('Account successfully deleted.');
                     handleLogout();
                } else {
                     alert('Account deletion error: ' + (data.message || response.statusText));
                }
             } catch (error) {
                 alert(`Network error: ${error.message}`);
             }
        }
        
        // Theme Logic
        function setTheme(themeName) {
            document.body.className = `theme-${themeName}`;
            localStorage.setItem('theme', themeName);
            document.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('active-theme'));
            document.querySelector(`.theme-option[data-theme="${themeName}"]`).classList.add('active-theme');
        }
        
        const storedTheme = localStorage.getItem('theme') || 'dark';
        setTheme(storedTheme);
        
        // File name display update
        document.getElementById('update-avatar-file').addEventListener('change', function() {
            document.getElementById('update-file-name-display').textContent = this.files.length ? this.files[0].name : 'Current avatar: unchanged';
        });

        // Initial check for token
        if (currentToken) {
             document.getElementById('auth-modal').style.display = 'none';
             connectSocket();
        } else {
             // If no token, the modal remains visible (it has display: block in HTML by default)
             connectSocket(); // Attempt connection anyway for initial auth setup
        }

        // Global modal closing: Close modal if background is clicked
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = "none";
            }
        };

        // Command processing for Admin Panel
        document.getElementById('admin-form').onsubmit = function(e) {
            e.preventDefault();
            const fullCommand = document.getElementById('admin-command-input').value.trim();
            const parts = fullCommand.split(' ');
            const cmd = parts[0].toLowerCase();
            let targetUsername = parts[1] || '';
            let message = '';
            
            if (cmd === 'announce') {
                 message = fullCommand.substring(fullCommand.toLowerCase().indexOf('announce') + 'announce'.length).trim();
            }
            
            socket.emit('adminCommand', { command: cmd, targetUsername: targetUsername, message: message });
            document.getElementById('admin-command-input').value = '';
        };

    </script>
</body>
</html>