<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChaoticCord - Discord Style</title>
    
    <style>
        /* --- üé® –°—Ç–∏–ª—å Discord (–°–µ—Ä—ã–π, –¢–µ–º–Ω—ã–π) --- */
        :root {
            --bg-darker: #1e1f22; /* –°–∞–º—ã–π —Ç–µ–º–Ω—ã–π —Ñ–æ–Ω (–°–µ—Ä–≤–µ—Ä—ã) */
            --bg-dark: #2b2d31;   /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω (–ö–∞–Ω–∞–ª—ã/–î—Ä—É–∑—å—è/–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏) */
            --bg-medium: #383a40; /* –§–æ–Ω —á–∞—Ç–∞ */
            --text-primary: #dbdee1;
            --text-secondary: #949ba4;
            --brand-color: #5865f2; /* –°–∏–Ω–∏–π/–§–∏–æ–ª–µ—Ç–æ–≤—ã–π */
            --online-color: #388647;
            --offline-color: #72767d;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-medium);
            color: var(--text-primary);
            overflow: hidden;
        }

        /* --- –û–±—â–∏–π –ú–∞–∫–µ—Ç (Grid) --- */
        #app-container {
            display: grid;
            /* –°–µ—Ä–≤–µ—Ä—ã | –ö–∞–Ω–∞–ª—ã/–î—Ä—É–∑—å—è | –ß–∞—Ç | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ */
            grid-template-columns: 72px 240px 1fr 240px; 
            height: 100vh;
        }

        /* --- 1. –ü–∞–Ω–µ–ª—å –°–µ—Ä–≤–µ—Ä–æ–≤ (Server List) --- */
        #server-list {
            grid-column: 1;
            background-color: var(--bg-darker);
            padding-top: 12px;
            overflow-y: auto;
        }
        .server-icon {
            width: 48px; height: 48px; margin: 8px auto; border-radius: 50%; 
            background-color: var(--bg-medium);
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; font-weight: bold; color: white; cursor: pointer;
            transition: border-radius 0.2s, background-color 0.2s;
        }
        .server-icon:hover { border-radius: 35%; background-color: var(--brand-color); }

        /* --- 2. –ü–∞–Ω–µ–ª—å –î—Ä—É–∑–µ–π/–ö–∞–Ω–∞–ª–æ–≤ (Friends/Channels) --- */
        #friends-channels-panel {
            grid-column: 2;
            background-color: var(--bg-dark);
            padding: 10px;
            overflow-y: auto;
        }
        #friends-channels-panel h3 {
            color: var(--text-secondary); font-size: 14px; text-transform: uppercase; margin-top: 20px;
        }
        .friend-item, .channel-item, .request-item {
            padding: 8px; display: flex; align-items: center; border-radius: 4px; cursor: pointer; margin-bottom: 2px;
        }
        .friend-item:hover, .channel-item:hover { background-color: var(--bg-medium); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; transition: background-color 0.3s; }
        .online { background-color: var(--online-color); }
        .offline { background-color: var(--offline-color); }

        /* --- 3. –û–±–ª–∞—Å—Ç—å –ß–∞—Ç–∞ (Chat Area) --- */
        #chat-area {
            grid-column: 3;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-medium);
            position: relative;
        }
        #messages-container {
            flex-grow: 1;
            padding: 0 20px 20px 20px;
            overflow-y: auto;
        }
        .message {
            margin-bottom: 12px; padding-top: 5px; display: flex; position: relative; animation: fadeIn 0.3s ease-out; 
        }
        .message-content { margin-left: 10px; }
        .message strong { color: white; margin-right: 5px; font-weight: 500; }
        .timestamp { color: var(--text-secondary); font-size: 12px; margin-left: 10px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background-color: var(--offline-color); }
        
        /* –í–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏–π */
        #form { padding: 15px 20px; background-color: var(--bg-medium); border-top: 1px solid #1e1f22; }
        #form-inner { display: flex; background-color: var(--bg-dark); border-radius: 8px; padding: 8px; }
        #input { border: none; padding: 0 10px; flex-grow: 1; background: none; color: var(--text-primary); outline: none; font-size: 16px; }
        #form > #form-inner > button { background-color: var(--brand-color); color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; }
        #form > #form-inner > button:hover { background-color: #4f5bcf; }

        /* --- 4. –°–ø–∏—Å–æ–∫ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (User List) --- */
        #user-list { grid-column: 4; background-color: var(--bg-dark); padding: 10px; overflow-y: auto; }
        #user-list h3 { color: var(--text-secondary); font-size: 12px; text-transform: uppercase; margin-bottom: 5px; }

        /* --- –≠–∫—Ä–∞–Ω—ã –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (Overlay) --- */
        #auth-screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-dark); z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #auth-form { background: var(--bg-darker); padding: 30px; border-radius: 5px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4); width: 350px; }
        #auth-form input { width: 90%; padding: 12px; margin: 8px 0; background-color: var(--bg-medium); border: 1px solid #2f3136; color: var(--text-primary); border-radius: 3px; outline: none; }
        #auth-form button { width: 100%; padding: 12px; margin-top: 10px; background-color: var(--brand-color); color: white; border: none; border-radius: 3px; font-size: 16px; cursor: pointer; }
        .auth-switch { text-align: center; color: var(--brand-color); cursor: pointer; font-size: 14px; margin-top: 10px; }
        .action-button { background-color: var(--online-color); color: white; border: none; padding: 4px 8px; border-radius: 3px; margin-left: 5px; cursor: pointer; font-size: 12px;}
        .action-button.reject { background-color: #da373c; }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

    </style>
</head>
<body>
    
    <div id="auth-screen">
        <form id="auth-form">
            <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h2>
            <input type="text" id="auth-username" placeholder="–ò–º—è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" required>
            <input type="password" id="auth-password" placeholder="–ü–∞—Ä–æ–ª—å" required>
            <button type="submit" id="auth-button">–í–æ–π—Ç–∏</button>
            <p id="auth-switch-text" class="auth-switch">
                <small>–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é</small>
            </p>
            <div id="auth-message" style="color: red; margin-top: 10px;"></div>
        </form>
    </div>

    <div id="app-container" style="display: none;">

        <aside id="server-list">
            <div class="server-icon" style="background-color: var(--brand-color);">C</div>
        </aside>

        <aside id="friends-channels-panel">
            <h2 style="font-size: 18px; color: white;">ChaoticCord</h2>
            
            <h3>–ö–ê–ù–ê–õ–´</h3>
            <div class="channel-item"># general</div>
            
            <h3>–î–†–£–ó–¨–Ø</h3>
            <ul id="friends-list-container" style="list-style: none; padding: 0;">
                </ul>
            
            <h3>–ó–ê–ü–†–û–°–´</h3>
            <ul id="friend-requests-container" style="list-style: none; padding: 0;">
                </ul>

            <input type="text" id="friend-request-input" placeholder="–î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞ –ø–æ –∏–º–µ–Ω–∏" style="width: 90%; padding: 5px; background: var(--bg-medium); border: none; color: white; margin-top: 10px; border-radius: 3px;">
            <button id="send-request-btn" style="width: 100%; margin-top: 5px; background: #388647; color: white; border: none; padding: 5px; border-radius: 3px;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ó–∞–ø—Ä–æ—Å</button>
        </aside>

        <main id="chat-area">
            <div id="messages-container">
                </div>
            
            <form id="form" action="">
                <div id="form-inner">
                    <input id="input" autocomplete="off" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ –≤ #general..." />
                    <button>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
            </form>
        </main>

        <aside id="user-list">
            <h3 id="online-users-count">–û–ù–õ–ê–ô–ù ‚Äî 0</h3>
            <ul id="online-users-list" style="list-style: none; padding: 0;">
                </ul>
        </aside>

    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // --- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ ---
        const API_URL = window.location.origin;
        let token = localStorage.getItem('token');
        let currentUserId = localStorage.getItem('userId');
        let currentUsername = localStorage.getItem('username');
        let isRegisterMode = false;
        
        // --- –≠–ª–µ–º–µ–Ω—Ç—ã GUI ---
        const authScreen = document.getElementById('auth-screen');
        const authForm = document.getElementById('auth-form');
        const authButton = document.getElementById('auth-button');
        const authMessage = document.getElementById('auth-message');
        const authSwitchText = document.getElementById('auth-switch-text');
        const appContainer = document.getElementById('app-container');
        const messagesContainer = document.getElementById('messages-container');
        const form = document.getElementById('form');
        const input = document.getElementById('input');
        const sendRequestBtn = document.getElementById('send-request-btn');
        const friendRequestInput = document.getElementById('friend-request-input');
        const friendRequestsContainer = document.getElementById('friend-requests-container');
        const onlineUsersList = document.getElementById('online-users-list');
        const onlineUsersCount = document.getElementById('online-users-count');

        let socket; 
        
        // --- 1. –õ–û–ì–ò–ö–ê –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò ---
        
        function toggleAuthMode() {
            isRegisterMode = !isRegisterMode;
            authButton.textContent = isRegisterMode ? '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è' : '–í–æ–π—Ç–∏';
            authSwitchText.innerHTML = isRegisterMode ? '<small>–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –í—Ö–æ–¥</small>' : '<small>–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é</small>';
        }
        authSwitchText.addEventListener('click', toggleAuthMode);

        authForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = document.getElementById('auth-username').value;
            const password = document.getElementById('auth-password').value;
            
            const endpoint = isRegisterMode ? '/api/register' : '/api/login';
            
            try {
                const response = await fetch(API_URL + endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (response.ok && !isRegisterMode) {
                    // –í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω
                    token = data.token;
                    currentUserId = data.userId;
                    currentUsername = data.username;
                    localStorage.setItem('token', token);
                    localStorage.setItem('userId', currentUserId);
                    localStorage.setItem('username', currentUsername);
                    
                    authScreen.style.display = 'none';
                    appContainer.style.display = 'grid';
                    connectSocket(); 
                    
                } else if (response.ok && isRegisterMode) {
                    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞
                    authMessage.textContent = '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ.';
                    authMessage.style.color = 'var(--online-color)';
                    toggleAuthMode();
                    
                } else {
                    // –û—à–∏–±–∫–∞
                    authMessage.textContent = data.message || '–û—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
                    authMessage.style.color = 'red';
                }
            } catch (error) {
                authMessage.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞.';
                authMessage.style.color = 'red';
            }
        });

        if (token) {
            authScreen.style.display = 'none';
            appContainer.style.display = 'grid';
            connectSocket(); 
        }

        // --- 2. –õ–û–ì–ò–ö–ê SOCKET.IO –ò –ß–ê–¢–ê ---
        
        function connectSocket() {
            socket = io(API_URL);
            
            socket.on('connect', () => {
                socket.emit('authenticate', token);
            });
            
            // –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            socket.on('newMessage', displayMessage);
            
            // –û—à–∏–±–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞
            socket.on('requestError', (message) => {
                console.error("Socket Error:", message);
                alert(`–û—à–∏–±–∫–∞: ${message}`);
            });
            
            // –£—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—Ä–æ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤ –¥—Ä—É–∑—å—è)
            socket.on('requestSuccess', (message) => {
                alert(`–£—Å–ø–µ—à–Ω–æ: ${message}`);
            });

            // –ù–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –≤ –¥—Ä—É–∑—å—è
            socket.on('newFriendRequest', displayFriendRequest);

            // –ü—Ä–∏–Ω—è—Ç–∏–µ –∑–∞–ø—Ä–æ—Å–∞
            socket.on('friendAccepted', (username) => {
                alert(`${username} –ø—Ä–∏–Ω—è–ª –≤–∞—à –∑–∞–ø—Ä–æ—Å –≤ –¥—Ä—É–∑—å—è!`);
                // –í –∏–¥–µ–∞–ª–µ: –æ–±–Ω–æ–≤–∏—Ç—å friends-list-container
            });
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ (–æ–Ω–ª–∞–π–Ω/–æ—Ñ—Ñ–ª–∞–π–Ω)
            socket.on('userStatusUpdate', updateOnlineUsers);
        }

        form.addEventListener('submit', function(e) {
            e.preventDefault(); 
            if (input.value.trim() && socket) {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä:
                socket.emit('chat message', {
                    content: input.value,
                });
                input.value = '';
            }
        });
        
        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
        function displayMessage(data) {
            const messageEl = document.createElement('div');
            messageEl.classList.add('message');
            
            messageEl.innerHTML = `
                <div class="avatar"></div>
                <div class="message-content">
                    <div>
                        <strong>${data.username}</strong>
                        <span class="timestamp">${new Date().toLocaleTimeString()}</span>
                    </div>
                    <div class="text">${data.content}</div>
                </div>
            `;
            
            messagesContainer.appendChild(messageEl);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // --- 3. –õ–û–ì–ò–ö–ê –î–†–£–ó–ï–ô ---

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
        sendRequestBtn.addEventListener('click', () => {
             const recipientUsername = friendRequestInput.value.trim();
             if (socket && recipientUsername) {
                 socket.emit('sendFriendRequest', { recipientUsername });
                 friendRequestInput.value = '';
             }
        });

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –≤ —Å–ø–∏—Å–∫–µ
        function displayFriendRequest(data) {
            // –£–¥–∞–ª–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —ç–ª–µ–º–µ–Ω—Ç, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
            let existingLi = document.getElementById(`request-${data.senderId}`);
            if (existingLi) existingLi.remove();

            const li = document.createElement('li');
            li.id = `request-${data.senderId}`;
            li.innerHTML = `
                <div class="request-item friend-item">
                    ${data.senderUsername}
                    <button class="action-button" onclick="acceptRequest('${data.senderId}')">–ü—Ä–∏–Ω—è—Ç—å</button>
                    <button class="action-button reject" onclick="rejectRequest('${data.senderId}')">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                </div>
            `;
            friendRequestsContainer.prepend(li); // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å —Å–≤–µ—Ä—Ö—É
        }

        // –ü—Ä–∏–Ω—è—Ç–∏–µ –∑–∞–ø—Ä–æ—Å–∞ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ –∫–Ω–æ–ø–∫–∏)
        function acceptRequest(senderId) {
            if (socket) {
                socket.emit('acceptFriendRequest', { senderId });
                // –£–¥–∞–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∏–∑ —Å–ø–∏—Å–∫–∞ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                document.getElementById(`request-${senderId}`).remove();
            }
        }
        
        // –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ (–Ω—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ!)
        function rejectRequest(senderId) {
            if (socket) {
                // socket.emit('rejectFriendRequest', { senderId }); // –°–µ—Ä–≤–µ—Ä–Ω–∞—è –ª–æ–≥–∏–∫–∞
                document.getElementById(`request-${senderId}`).remove();
                alert('–ó–∞–ø—Ä–æ—Å –æ—Ç–∫–ª–æ–Ω–µ–Ω (—Ç–æ–ª—å–∫–æ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ, —Å–µ—Ä–≤–µ—Ä–Ω–∞—è –ª–æ–≥–∏–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞).');
            }
        }
        
        // --- 4. –õ–û–ì–ò–ö–ê –°–¢–ê–¢–£–°–ê –û–ù–õ–ê–ô–ù ---
        
        const onlineUsers = {}; // –•—Ä–∞–Ω–∏–ª–∏—â–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: userId -> {username, status}

        function updateOnlineUsers(data) {
            if (data.status === 'online') {
                onlineUsers[data.userId] = { username: data.username, status: 'online' };
            } else if (data.status === 'offline') {
                delete onlineUsers[data.userId];
            }
            
            renderOnlineList();
        }

        function renderOnlineList() {
            onlineUsersList.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
            const usersArray = Object.values(onlineUsers).filter(u => u.username !== currentUsername);
            
            usersArray.forEach(user => {
                const li = document.createElement('li');
                li.classList.add('friend-item');
                li.innerHTML = `
                    <span class="status-dot online"></span>
                    ${user.username}
                `;
                onlineUsersList.appendChild(li);
            });
            
            onlineUsersCount.textContent = `–û–ù–õ–ê–ô–ù ‚Äî ${usersArray.length}`;
        }
    </script>
</body>
</html>