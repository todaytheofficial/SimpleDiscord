<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeoCord Messenger (Friends Only)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <link rel="stylesheet" href="style.css">

    <style>
        #chat-area {
            display: flex;
            flex-direction: column;
            height: 100%; /* Ensure main is full height */
        }
        #messages-container {
            /* 1. CRITICAL: Allows scrolling and takes up remaining vertical space */
            flex: 1; 
            overflow-y: auto; 
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        /* Add basic message styling if not in style.css */
        .message {
            display: flex;
            align-items: flex-start;
        }
        .message .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            flex-shrink: 0;
        }
        .message-content {
            background-color: var(--bg-secondary);
            padding: 10px 15px;
            border-radius: 8px;
            max-width: 70%;
        }
        .message-content strong {
            color: var(--text-primary);
        }
        .message-content .timestamp {
            font-size: 11px;
            color: var(--text-sub);
            margin-left: 10px;
        }
    </style>
</head>
<body class="theme-dark">
    
    <div id="auth-screen" class="modal">
        <div class="modal-content" style="margin-top: 15%;">
            <form id="auth-form" enctype="multipart/form-data">
                <h2>Добро пожаловать в NeoCord</h2>
                <input type="text" id="auth-username" name="username" placeholder="Имя пользователя" required class="modal-input">
                <input type="password" id="auth-password" name="password" placeholder="Пароль" required class="modal-input">
                
                <div id="auth-avatar-upload" style="display: none; margin: 10px 0;">
                    <label for="auth-avatar-file" class="file-input-container">
                        <span id="auth-file-name">Выберите аватар (макс. 2МБ)</span>
                    </label>
                    <input type="file" id="auth-avatar-file" name="avatar" accept="image/jpeg,image/png,image/gif" style="display: none;">
                </div>

                <button type="submit" id="auth-button" class="modal-button">Войти</button>
                <p id="auth-switch-text" class="auth-switch">
                    <small>Переключиться на Регистрацию</small>
                </p>
                <div id="auth-message" style="color: var(--danger-color); margin-top: 10px;"></div>
            </form>
        </div>
    </div>

    <div id="app-container" style="display: none;">

        <aside id="friends-channels-panel">
            
            <input type="text" id="friend-search-input" placeholder="Найти или начать разговор (Поиск)" />
            
            <button id="start-dm-btn" class="modal-button" style="width: 100%; padding: 8px; margin-bottom: 10px; font-size: 15px; background: var(--brand-color);">
                <i class="fas fa-user-plus"></i> Добавить друга
            </button>

            <div class="friend-list-header">
                <span id="show-friends-btn" class="active"><i class="fas fa-users"></i> Друзья</span>
                <span id="show-requests-btn"><i class="fas fa-inbox"></i> Заявки (<span id="request-count">0</span>)</span>
            </div>

            <hr style="border-top: 1px solid var(--bg-tertiary); margin: 0 0 10px 0;">
            
            <div id="dm-section">
                
                <div id="current-friends-view">
                    <h3>ЛИЧНЫЕ СООБЩЕНИЯ</h3>
                    <ul id="dm-list-container" style="list-style: none; padding: 0;"></ul>
                </div>

                <div id="incoming-requests-view" style="display: none;">
                    <h3>ВХОДЯЩИЕ ЗАЯВКИ</h3>
                    <ul id="incoming-requests-list" style="list-style: none; padding: 0;"></ul>
                </div>
            </div>

            <hr style="border-top: 1px solid var(--bg-tertiary); margin: 10px 0;">
            <button id="admin-console-btn" class="modal-button" style="width: 100%; padding: 8px; font-size: 15px; background: var(--danger-color); display: none;">
                <i class="fas fa-terminal"></i> Admin Console
            </button>

            <div id="user-profile-bar">
                <img id="my-avatar" class="avatar" src="" alt="Avatar" style="border-radius: 50%; width: 32px; height: 32px;">
                <div style="flex-grow: 1;">
                    <strong id="my-username"></strong>
                    <div style="color: var(--text-sub); font-size: 11px;">#0000</div>
                </div>
                <div class="status-indicator"></div>
                <i class="fas fa-cog" id="open-settings-btn" style="color: var(--text-sub); margin-left: 10px; cursor: pointer;"></i>
            </div>
        </aside>

        <main id="chat-area">
             <header>
                <strong id="current-chat-title">Друзья</strong>
            </header>
            <div id="messages-container">
                <p style="text-align: center; color: var(--text-sub); margin-top: 50px;">
                    Добро пожаловать! Выберите друга, чтобы начать разговор.
                </p>
            </div>
            
            <form id="form" action="">
                <div id="form-inner">
                    <input id="input" autocomplete="off" placeholder="Напишите сообщение..." />
                    <button type="submit"><i class="fas fa-paper-plane"></i> Отправить</button>
                </div>
            </form>
        </main>
    </div>

    <div id="profile-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('profile-modal')">&times;</span>
            <h2 id="modal-profile-title">Профиль</h2>
            <div style="text-align: center; margin-bottom: 20px;">
                <img id="modal-avatar" class="avatar" style="width: 80px; height: 80px; margin: 10px;" src="" alt="Avatar">
                <h3 id="modal-username"></h3>
                <p id="modal-status" style="color: var(--online-color);"></p>
            </div>
            
            <button class="modal-button" id="add-friend-btn" style="background-color: var(--online-color); display: none;">Действие</button>
        </div>
    </div>
    
    <div id="start-dm-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('start-dm-modal')">&times;</span>
            <h2>Отправить заявку в друзья</h2>
            <input type="text" id="dm-recipient-input" placeholder="Введите имя пользователя" class="modal-input">
            <button class="modal-button" id="submit-start-dm">Отправить запрос</button>
        </div>
    </div>
    
    <div id="settings-modal" class="modal">
        <div class="modal-content" style="width: 600px; max-width: 90%; display: flex;">
            <div style="flex-shrink: 0; width: 180px; padding: 30px 20px 30px 30px; border-right: 1px solid var(--border-color);">
                <h3 style="margin-top: 0;">Настройки пользователя</h3>
                <ul id="settings-menu" style="list-style: none; padding: 0; font-size: 15px;">
                    <li class="setting-item active" data-section="my-account">Мой аккаунт</li>
                    <li class="setting-item" data-section="themes">Внешний вид</li>
                    <li class="setting-item" data-section="privacy">Приватность</li>
                    <li class="setting-item logout-item" id="logout-btn">Выход</li>
                </ul>
            </div>

            <div id="settings-content" style="flex-grow: 1; padding: 30px;">
                <span class="close" onclick="closeModal('settings-modal')" style="position: absolute; top: 10px; right: 15px;">&times;</span>
                
                <div class="settings-section" id="my-account">
                    <h2>Мой аккаунт</h2>
                    <div style="background-color: var(--bg-tertiary); padding: 15px; border-radius: 8px;">
                        <h4>Информация профиля</h4>
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <img id="settings-avatar-preview" class="avatar" style="width: 60px; height: 60px; margin-right: 15px;" src="" alt="Avatar">
                            <div>
                                <strong id="settings-username-display"></strong>
                                <div style="color: var(--text-sub); font-size: 12px;">Измените свои данные.</div>
                            </div>
                        </div>
                        
                        <input type="text" id="new-username-input" placeholder="Новое имя пользователя" class="modal-input" style="width: calc(100% - 24px);">
                        
                        <div style="margin: 10px 0;">
                            <label for="new-avatar-file" class="file-input-container">
                                <span id="profile-file-name">Загрузить новый аватар с ПК</span>
                            </label>
                            <input type="file" id="new-avatar-file" name="avatar" accept="image/jpeg,image/png,image/gif" style="display: none;">
                        </div>
                        
                        <button class="modal-button" id="update-profile-btn" style="background-color: var(--online-color);">Сохранить изменения</button>
                    </div>

                    <h4 style="color: var(--danger-color); margin-top: 30px;">Опасная зона</h4>
                    <button class="modal-button" id="delete-account-btn" style="background-color: var(--danger-color); width: auto; padding: 10px 20px;">
                        Удалить аккаунт
                    </button>
                </div>
                
                <div class="settings-section" id="themes" style="display: none;">
                    <h2>Внешний вид</h2>
                    <h4>Выбор темы</h4>
                    <div style="display: flex; gap: 20px;">
                        <div class="theme-option" data-theme="dark">
                            <i class="fas fa-moon"></i> Темная (По умолчанию)
                        </div>
                        <div class="theme-option" data-theme="light">
                            <i class="fas fa-sun"></i> Светлая
                        </div>
                        <div class="theme-option" data-theme="custom">
                            <i class="fas fa-palette"></i> Soft Blue
                        </div>
                    </div>
                </div>
                
                <div class="settings-section" id="privacy" style="display: none;">
                    <h2>Приватность и безопасность</h2>
                    <p style="color: var(--text-sub);">Будущие настройки приватности появятся здесь.</p>
                </div>
            </div>
        </div>
    </div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // --- Variables and Storage ---
        const API_URL = window.location.origin;
        let token = localStorage.getItem('token');
        let currentUserId = parseInt(localStorage.getItem('userId'));
        let currentUsername = localStorage.getItem('username');
        let currentAvatar = localStorage.getItem('avatar') || '/img/anon_blue.png'; 
        let currentChatId = 0; 
        let isChatDM = true; 
        let isRegisterMode = false;
        let socket; 
        
        let friends = []; 
        let pendingRequests = []; 
        let dms = {}; 
        
        // --- GUI Elements ---
        const authScreen = document.getElementById('auth-screen');
        const authForm = document.getElementById('auth-form');
        const appContainer = document.getElementById('app-container');
        const messagesContainer = document.getElementById('messages-container');
        const input = document.getElementById('input');
        const messageForm = document.getElementById('form');
        const myAvatarEl = document.getElementById('my-avatar');
        const myUsernameEl = document.getElementById('my-username');
        const currentChatTitleEl = document.getElementById('current-chat-title');
        const dmListContainer = document.getElementById('dm-list-container');
        const statusIndicatorEl = document.querySelector('.status-indicator');
        const openSettingsBtn = document.getElementById('open-settings-btn');
        const authSwitchText = document.getElementById('auth-switch-text');
        
        const showFriendsBtn = document.getElementById('show-friends-btn');
        const showRequestsBtn = document.getElementById('show-requests-btn');
        const currentFriendsView = document.getElementById('current-friends-view');
        const incomingRequestsView = document.getElementById('incoming-requests-view');
        
        const startDmBtn = document.getElementById('start-dm-btn');
        const submitStartDmBtn = document.getElementById('submit-start-dm');
        
        const settingsModal = document.getElementById('settings-modal');
        const settingsMenu = document.getElementById('settings-menu');
        const updateProfileBtn = document.getElementById('update-profile-btn');
        const deleteAccountBtn = document.getElementById('delete-account-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const newUsernameInput = document.getElementById('new-username-input');
        const newAvatarFile = document.getElementById('new-avatar-file');
        const settingsAvatarPreview = document.getElementById('settings-avatar-preview');
        const settingsUsernameDisplay = document.getElementById('settings-username-display');

        const adminConsoleBtn = document.getElementById('admin-console-btn');
        
        // Helper function for creating elements (DRY)
        function createElement(tag, className = '', content = '') {
            const el = document.createElement(tag);
            if (className) el.className = className;
            if (content) el.innerHTML = content;
            return el;
        }

        // --- 0. THEMES AND MODALS ---
        
        function setTheme(theme) {
            document.body.className = `theme-${theme}`;
            localStorage.setItem('theme', theme);
            document.querySelectorAll('.theme-option').forEach(opt => {
                opt.classList.toggle('active-theme', opt.dataset.theme === theme);
            });
        }
        
        function openModal(id) {
            if (id === 'settings-modal') { loadSettingsData(); } 
            document.getElementById(id).style.display = 'block';
        }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        
        // --- AUTH/INIT LOGIC ---
        
        function toggleAuthMode() {
            isRegisterMode = !isRegisterMode;
            document.getElementById('auth-avatar-upload').style.display = isRegisterMode ? 'block' : 'none';
            document.getElementById('auth-button').textContent = isRegisterMode ? 'Зарегистрироваться' : 'Войти';
            authSwitchText.querySelector('small').textContent = isRegisterMode ? 'Переключиться на Вход' : 'Переключиться на Регистрацию';
            document.getElementById('auth-message').textContent = '';
        }

        function updateGUI() {
            myUsernameEl.textContent = currentUsername;
            myAvatarEl.src = currentAvatar;
            statusIndicatorEl.style.backgroundColor = 'var(--online-color)';
            // Показать кнопку админ-консоли, если ID = 100 (Today_Idk)
            adminConsoleBtn.style.display = (currentUserId === 100) ? 'block' : 'none'; 
        }

        function handleLogout() {
            localStorage.removeItem('token');
            localStorage.removeItem('userId');
            localStorage.removeItem('username');
            localStorage.removeItem('avatar');
            location.reload(); 
        }
        
        // --- SOCKET.IO AND CHAT LOGIC ---
        
        function connectSocket() { 
            if (socket) { socket.disconnect(); }
            socket = io(API_URL);
            
            socket.on('connect', () => {
                socket.emit('authenticate', token);
            });
            
            socket.on('newMessage', displayMessage);
            
            socket.on('messageHistory', (history) => {
                messagesContainer.innerHTML = ''; 
                if (history.length === 0) {
                     messagesContainer.innerHTML = `<p style="text-align: center; color: var(--text-sub); margin-top: 50px;">Начните разговор!</p>`;
                }
                history.forEach(msg => displayMessage(msg, true)); 
                messagesContainer.scrollTop = messagesContainer.scrollHeight; 
            });

            socket.on('systemAnnouncement', (msg) => {
                // ФИКС: Объявление использует данные из msg (включая аватарку админа)
                displayMessage(msg); 
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });

            socket.on('userUpdateInfo', (data) => {
                 if (data.userId == currentUserId) {
                    if (data.newUsername) { 
                        currentUsername = data.newUsername; 
                        localStorage.setItem('username', currentUsername); 
                    }
                    if (data.newAvatar) { 
                        currentAvatar = data.newAvatar; 
                        localStorage.setItem('avatar', currentAvatar); 
                    }
                    updateGUI();
                 }
                 socket.emit('authenticate', token); 
            });
            
            socket.on('initialData', (data) => {
                friends = data.friends; 
                pendingRequests = data.pendingRequests; 
                dms = data.dms; 

                currentChatId = data.activeChatId;
                isChatDM = true;
                
                renderDMs(); 
                renderRequests(); 
                
                updateChatHeader(currentChatId, isChatDM);
                if (data.activeChatId !== 0) {
                    socket.emit('joinChat', { newId: currentChatId, isDM: true });
                } else {
                    setActiveFriendsView('friends'); 
                }
            });

            socket.on('friendRequestReceived', (data) => {
                alert(`Новая заявка в друзья от ${data.username}! Проверьте 'Заявки'.`);
                pendingRequests.push(data);
                renderRequests();
            });
            
            socket.on('friendRequestAccepted', (data) => {
                alert(`${data.username} принял(а) вашу заявку!`);
                pendingRequests = pendingRequests.filter(req => req.userId != data.userId);
                renderRequests();
                friends.push(data);
                dms[data.userId] = { channelId: data.channelId }; 
                renderDMs(); 
            });
            
            socket.on('chatChanged', (data) => {
                currentChatId = data.newId;
                isChatDM = data.isDM;
                renderDMs(); 
                updateChatHeader(currentChatId, isChatDM);
            });
            
            socket.on('requestError', (message) => { alert(`Ошибка: ${message}`); });
            socket.on('requestSuccess', (message) => { alert(`Успешно: ${message}`); });
            
            socket.on('accountDeleted', () => {
                 alert('Ваш аккаунт был успешно удален.');
                 handleLogout();
            });
        }
        
        function displayMessage(msg, isHistory = false) {
            const item = createElement('div', 'message');
            
            const avatarImg = createElement('img', 'avatar');
            avatarImg.src = msg.avatar;
            item.appendChild(avatarImg);
            
            const contentDiv = createElement('div', 'message-content');
            
            const header = createElement('div');
            // Check if it's an announcement for specific styling
            const isAnnouncement = msg.username === 'SYSTEM ANNOUNCEMENT';
            const usernameStyle = isAnnouncement ? 'color: var(--danger-color); font-weight: bold;' : '';
            
            header.innerHTML = `<strong style="${usernameStyle}">${msg.username}</strong> <span class="timestamp">${new Date(msg.timestamp).toLocaleTimeString('ru-RU')}</span>`;
            contentDiv.appendChild(header);
            
            const text = createElement('p', '', msg.content);
            contentDiv.appendChild(text);
            
            item.appendChild(contentDiv);
            messagesContainer.appendChild(item);
            
            if (!isHistory) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight; 
            }
        }
        
        function updateChatHeader(chatId, isDM) {
            if (chatId === 0) {
                currentChatTitleEl.textContent = 'Друзья';
                messagesContainer.innerHTML = `<p style="text-align: center; color: var(--text-sub); margin-top: 50px;">Добро пожаловать! Выберите друга, чтобы начать разговор.</p>`;
                return;
            }
            
            if (isDM) {
                const partner = friends.find(f => dms[f.userId] && dms[f.userId].channelId === chatId);
                if (partner) {
                    currentChatTitleEl.textContent = partner.username;
                } else {
                     currentChatTitleEl.textContent = 'DM Чат';
                }
            } else {
                 currentChatTitleEl.textContent = 'Чат Канала'; 
            }
        }
        
        function renderDMs() {
            dmListContainer.innerHTML = '';
            friends.forEach(friend => {
                const channelId = dms[friend.userId] ? dms[friend.userId].channelId : 0;
                
                const item = createElement('li');
                const div = createElement('div', `friend-item ${channelId === currentChatId ? 'active' : ''}`);
                div.dataset.channelId = channelId;
                div.dataset.isDm = true;
                div.dataset.userId = friend.userId;
                
                div.innerHTML = `<img class="avatar" src="${friend.avatar}" alt="${friend.username}"> ${friend.username}`;
                
                div.addEventListener('click', (e) => {
                    const id = parseInt(e.currentTarget.dataset.channelId);
                    if (id !== currentChatId) {
                        joinChat(id, true);
                    }
                    setActiveFriendsView('friends');
                });
                
                item.appendChild(div);
                dmListContainer.appendChild(item);
            });
        }
        
        function renderRequests() {
            const list = document.getElementById('incoming-requests-list');
            list.innerHTML = '';
            document.getElementById('request-count').textContent = pendingRequests.length;

            if (pendingRequests.length === 0) {
                list.innerHTML = `<li style="padding: 10px; color: var(--text-sub);">Нет входящих заявок.</li>`;
            }

            pendingRequests.forEach(req => {
                const item = createElement('li');
                item.className = 'friend-item';
                item.innerHTML = `
                    <img class="avatar" src="${req.avatar}" alt="${req.username}">
                    <div style="flex-grow: 1;">${req.username}</div>
                    <button class="request-action-btn accept" data-user-id="${req.userId}"><i class="fas fa-check"></i></button>
                    <button class="request-action-btn reject" data-user-id="${req.userId}"><i class="fas fa-times"></i></button>
                `;
                list.appendChild(item);
            });
        }
        
        function joinChat(id, isDM, emit = true) {
            currentChatId = id;
            isChatDM = isDM;
            if (emit) {
                socket.emit('joinChat', { newId: id, isDM: isDM });
            }
            renderDMs();
            updateChatHeader(currentChatId, isChatDM); 
            messagesContainer.innerHTML = `<p style="text-align: center; color: var(--text-sub); margin-top: 50px;">Загрузка истории...</p>`;
        }
        
        function setActiveFriendsView(view) {
             showFriendsBtn.classList.toggle('active', view === 'friends');
             showRequestsBtn.classList.toggle('active', view === 'requests');
             currentFriendsView.style.display = view === 'friends' ? 'block' : 'none';
             incomingRequestsView.style.display = view === 'requests' ? 'block' : 'none';
        }
        
        // --- 4. PROFILE AND SETTINGS LOGIC ---
        
        function loadSettingsData() {
            settingsAvatarPreview.src = currentAvatar;
            settingsUsernameDisplay.textContent = currentUsername;
            newUsernameInput.value = currentUsername;
            newAvatarFile.value = '';
            document.getElementById('profile-file-name').textContent = 'Загрузить новый аватар с ПК';
            
            const currentTheme = localStorage.getItem('theme') || 'dark';
            document.querySelectorAll('.theme-option').forEach(opt => {
                opt.classList.toggle('active-theme', opt.dataset.theme === currentTheme);
            });
            
            document.querySelectorAll('.settings-section').forEach(sec => sec.style.display = 'none');
            document.getElementById('my-account').style.display = 'block';
            document.querySelectorAll('.setting-item').forEach(item => item.classList.remove('active'));
            document.querySelector('.setting-item[data-section="my-account"]').classList.add('active');
        }

        // --- ADMIN CONSOLE LOGIC ---
        function openAdminConsole() {
            if (currentUserId !== 100) { 
                alert('Доступ запрещен. Только создатель может использовать эту консоль.');
                return;
            }

            const commandInput = prompt(`
                ADMIN CONSOLE (Today_Idk)
                Команды:
                1. listusers
                2. block [username]
                3. unblock [username]
                4. announce [message] (Пример: announce Привет всем!)
                
                Введите команду:
            `);

            if (!commandInput) return;

            const parts = commandInput.trim().split(/\s+/);
            const cmd = parts[0].toLowerCase();
            let targetUsername = '';
            let messageContent = '';

            if (cmd === 'block' || cmd === 'unblock') {
                targetUsername = parts[1];
                if (!targetUsername) {
                    alert(`Ошибка: Отсутствует имя пользователя для команды ${cmd}.`);
                    return;
                }
            } else if (cmd === 'announce') {
                // Get everything after the first word "announce"
                const announceIndex = commandInput.toLowerCase().indexOf('announce');
                messageContent = commandInput.substring(announceIndex + 'announce'.length).trim();
                
                if (!messageContent) {
                    alert('Ошибка: Сообщение для объявления пусто.');
                    return;
                }
            } else if (cmd !== 'listusers') {
                 // Check for unknown commands that don't need a target/message
                 if (!['listusers'].includes(cmd)) {
                     alert(`Неизвестная команда: ${cmd}`);
                     return;
                 }
            }
            
            // Send command to server
            socket.emit('adminCommand', { 
                command: cmd, 
                targetUsername: targetUsername, 
                message: messageContent
            });
        }


        // --- Event Listeners ---
        
        function initializeListeners() {
            if (localStorage.getItem('theme')) { setTheme(localStorage.getItem('theme')); } else { setTheme('dark'); }
            
            authSwitchText.addEventListener('click', toggleAuthMode);
            
            authForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const endpoint = isRegisterMode ? '/api/register' : '/api/login';
                
                let requestOptions = { method: 'POST' };

                if (isRegisterMode) {
                    requestOptions.body = new FormData(authForm);
                } else {
                    requestOptions.headers = { 'Content-Type': 'application/json' };
                    requestOptions.body = JSON.stringify({
                        username: document.getElementById('auth-username').value,
                        password: document.getElementById('auth-password').value
                    });
                }
                
                try {
                    const response = await fetch(API_URL + endpoint, requestOptions);
                    const data = await response.json();
                    
                    const authMessageEl = document.getElementById('auth-message');
                    
                    if (response.ok && !isRegisterMode) {
                        token = data.token;
                        currentUserId = data.userId;
                        currentUsername = data.username;
                        currentAvatar = data.avatar;

                        localStorage.setItem('token', token);
                        localStorage.setItem('userId', currentUserId);
                        localStorage.setItem('username', currentUsername);
                        localStorage.setItem('avatar', currentAvatar);
                        
                        authScreen.style.display = 'none';
                        appContainer.style.display = 'grid';
                        updateGUI();
                        connectSocket(); 
                    } else if (response.ok && isRegisterMode) {
                        authMessageEl.textContent = 'Регистрация прошла успешно! Пожалуйста, войдите.';
                        authMessageEl.style.color = 'var(--online-color)';
                        toggleAuthMode();
                    } else {
                        authMessageEl.textContent = data.message || 'Ошибка. Повторите попытку.';
                        authMessageEl.style.color = 'var(--danger-color)';
                    }
                } catch (error) {
                    document.getElementById('auth-message').textContent = 'Сетевая или серверная ошибка.';
                    document.getElementById('auth-message').style.color = 'var(--danger-color)';
                }
            });

            messageForm.addEventListener('submit', function(e) {
                e.preventDefault();
                if (input.value.trim() && socket && currentChatId !== 0) {
                    socket.emit('chat message', { content: input.value.trim() });
                    input.value = '';
                }
            });
            
            window.onclick = function(event) {
                if (event.target.classList.contains('modal')) { event.target.style.display = "none"; }
            }
            
            showFriendsBtn.addEventListener('click', () => setActiveFriendsView('friends'));
            showRequestsBtn.addEventListener('click', () => setActiveFriendsView('requests'));
            
            startDmBtn.addEventListener('click', () => openModal('start-dm-modal'));
            submitStartDmBtn.addEventListener('click', () => {
                 const recipientUsername = document.getElementById('dm-recipient-input').value.trim();
                 if (recipientUsername) {
                     socket.emit('sendFriendRequest', recipientUsername);
                     document.getElementById('dm-recipient-input').value = '';
                     closeModal('start-dm-modal');
                 }
            });
            
            openSettingsBtn.addEventListener('click', () => openModal('settings-modal'));
            
            // Listener for Admin Console Button
            adminConsoleBtn.addEventListener('click', openAdminConsole);
            
            settingsMenu.addEventListener('click', (e) => {
                const item = e.target.closest('.setting-item');
                if (!item || item.classList.contains('logout-item')) return;
                
                document.querySelectorAll('.setting-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');

                const sectionId = item.dataset.section;
                document.querySelectorAll('.settings-section').forEach(sec => sec.style.display = 'none');
                document.getElementById(sectionId).style.display = 'block';
            });
            
            document.querySelectorAll('.theme-option').forEach(btn => {
                btn.addEventListener('click', function() {
                    setTheme(this.dataset.theme);
                });
            });
            
            updateProfileBtn.addEventListener('click', async () => {
                const newUsername = newUsernameInput.value.trim();
                const formData = new FormData();
                formData.append('newUsername', newUsername);
                if (newAvatarFile.files[0]) {
                    formData.append('avatar', newAvatarFile.files[0]);
                }

                try {
                    const response = await fetch(`${API_URL}/api/update-profile`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData 
                    });

                    const data = await response.json();

                    if (response.ok) {
                        alert('Профиль успешно обновлен!');
                        closeModal('settings-modal');
                        
                    } else { alert(`Обновление не удалось: ${data.message || 'Ошибка сервера'}`); }
                } catch (error) { alert('Сетевая ошибка при обновлении профиля.'); }
            });

            deleteAccountBtn.addEventListener('click', async () => {
                if (!confirm('Вы уверены, что хотите безвозвратно удалить свой аккаунт? Это действие отменить невозможно.')) { return; }
                try {
                    const response = await fetch(`${API_URL}/api/delete-account`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!response.ok) {
                        const data = await response.json();
                        alert(`Ошибка удаления: ${data.message || 'Ошибка сервера'}`);
                    }
                } catch (error) { alert('Сетевая ошибка при удалении аккаунта.'); }
            });

            logoutBtn.addEventListener('click', handleLogout);
            
            document.getElementById('auth-avatar-file').addEventListener('change', (e) => {
                 document.getElementById('auth-file-name').textContent = e.target.files.length > 0 ? e.target.files[0].name : 'Выберите аватар (макс. 2МБ)';
            });
            newAvatarFile.addEventListener('change', (e) => {
                 document.getElementById('profile-file-name').textContent = e.target.files.length > 0 ? e.target.files[0].name : 'Загрузить новый аватар с ПК';
                 if (e.target.files.length > 0) {
                     const reader = new FileReader();
                     reader.onload = function(event) { settingsAvatarPreview.src = event.target.result; };
                     reader.readAsDataURL(e.target.files[0]);
                 }
            });
            
            document.getElementById('incoming-requests-list').addEventListener('click', (e) => {
                const btn = e.target.closest('.request-action-btn');
                if (!btn) return;
                
                const userId = parseInt(btn.dataset.userId);
                const action = btn.classList.contains('accept') ? 'accept' : 'reject';

                if (socket) {
                    socket.emit('handleFriendRequest', { userId, action });
                }
                
                pendingRequests = pendingRequests.filter(req => req.userId !== userId);
                renderRequests();
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            initializeListeners();
            if (token) {
                authScreen.style.display = 'none';
                appContainer.style.display = 'grid';
                updateGUI();
                connectSocket(); 
            } else {
                authScreen.style.display = 'flex';
            }
        });

    </script>
</body>
</html>