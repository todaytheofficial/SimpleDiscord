<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChaoticCord</title>
    
    <style>
        /* --- üé® –°—Ç–∏–ª—å Discord –∏ –¢–µ–º—ã --- */
        /* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é - –¢–µ–º–Ω–∞—è –¢–µ–º–∞ */
        :root {
            --bg-darker: #1e1f22; 
            --bg-dark: #2b2d31;   
            --bg-medium: #383a40; 
            --text-primary: #dbdee1;
            --text-secondary: #949ba4;
            --brand-color: #5865f2; 
            --online-color: #388647;
            --offline-color: #72767d;
            --input-bg: #2b2d31;
            --card-bg: #2b2d31;
        }

        /* –°–≤–µ—Ç–ª–∞—è –¢–µ–º–∞ (Light Theme) */
        .theme-light {
            --bg-darker: #f2f3f5;
            --bg-dark: #ffffff;
            --bg-medium: #f2f3f5;
            --text-primary: #2e3338;
            --text-secondary: #5c626a;
            --brand-color: #5865f2;
            --online-color: #388647;
            --offline-color: #72767d;
            --input-bg: #e3e5e8;
            --card-bg: #ffffff;
        }
        
        /* –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ */
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background-color: var(--bg-medium); color: var(--text-primary); overflow: hidden; }
        #app-container { display: grid; grid-template-columns: 72px 240px 1fr 240px; height: 100vh; }
        
        /* –°–µ—Ä–≤–µ—Ä—ã */
        #server-list { grid-column: 1; background-color: var(--bg-darker); padding-top: 12px; overflow-y: auto; }
        .server-icon { width: 48px; height: 48px; margin: 8px auto; border-radius: 50%; background-color: var(--bg-medium); display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; color: white; cursor: pointer; transition: border-radius 0.2s, background-color 0.2s; }
        .server-icon:hover { border-radius: 35%; background-color: var(--brand-color); }

        /* –ö–∞–Ω–∞–ª—ã/–î—Ä—É–∑—å—è (2-—è –∫–æ–ª–æ–Ω–∫–∞) */
        #friends-channels-panel { grid-column: 2; background-color: var(--bg-dark); padding: 10px; overflow-y: auto; display: flex; flex-direction: column;}
        #friends-channels-panel h3 { color: var(--text-secondary); font-size: 14px; text-transform: uppercase; margin-top: 20px; }
        .friend-item, .channel-item, .request-item { padding: 8px; display: flex; align-items: center; border-radius: 4px; cursor: pointer; margin-bottom: 2px; transition: background-color 0.1s;}
        .channel-item.active { background-color: var(--bg-medium); color: var(--text-primary); }
        .friend-item:hover, .channel-item:hover { background-color: var(--bg-medium); }
        .channel-item { padding-left: 12px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; }
        .online { background-color: var(--online-color); }
        .offline { background-color: var(--offline-color); }

        /* –ü—Ä–æ—Ñ–∏–ª—å –≤–Ω–∏–∑—É (2-—è –∫–æ–ª–æ–Ω–∫–∞) */
        #user-profile-bar { margin-top: auto; padding: 8px; background-color: var(--bg-darker); display: flex; align-items: center; cursor: pointer;}
        #user-profile-bar .avatar { width: 32px; height: 32px; margin-right: 8px;}
        #user-profile-bar strong { font-size: 14px; }
        
        /* –ß–∞—Ç */
        #chat-area { grid-column: 3; display: flex; flex-direction: column; background-color: var(--bg-medium); position: relative; }
         #chat-area header { padding: 10px 20px; border-bottom: 1px solid var(--bg-dark); background: var(--bg-dark); color: white; }
        #messages-container { flex-grow: 1; padding: 0 20px 20px 20px; overflow-y: auto; }
        .message { margin-bottom: 12px; padding-top: 5px; display: flex; position: relative; }
        .message-content { margin-left: 10px; }
        .message strong { color: white; margin-right: 5px; font-weight: 500; }
        .timestamp { color: var(--text-secondary); font-size: 12px; margin-left: 10px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background-color: var(--offline-color); }
        .avatar:hover { cursor: pointer; }
        
        /* –í–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏–π */
        #form { padding: 15px 20px; background-color: var(--bg-medium); }
        #form-inner { display: flex; background-color: var(--input-bg); border-radius: 8px; padding: 8px; border: 1px solid var(--bg-dark); }
        #input { border: none; padding: 0 10px; flex-grow: 1; background: none; color: var(--text-primary); outline: none; font-size: 16px; }
        #form > #form-inner > button { background-color: var(--brand-color); color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; }
        #form > #form-inner > button:hover { background-color: #4f5bcf; }
        .action-button { background-color: var(--online-color); color: white; border: none; padding: 4px 8px; border-radius: 3px; margin-left: 5px; cursor: pointer; font-size: 12px;}
        .action-button.reject { background-color: #da373c; }

        /* –°–ø–∏—Å–æ–∫ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (4-—è –∫–æ–ª–æ–Ω–∫–∞) */
        #user-list { grid-column: 4; background-color: var(--bg-dark); padding: 10px; overflow-y: auto; }
        #user-list h3 { color: var(--text-secondary); font-size: 12px; text-transform: uppercase; margin-bottom: 5px; }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); }
        .modal-content { background-color: var(--card-bg); margin: 10% auto; padding: 30px; border-radius: 8px; width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); color: var(--text-primary); }
        .close { color: var(--text-secondary); float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: var(--text-primary); }
        .modal-input { width: 95%; padding: 10px; margin: 10px 0; background-color: var(--bg-medium); border: 1px solid var(--bg-dark); color: var(--text-primary); border-radius: 3px; outline: none; }
        .modal-button { width: 100%; padding: 10px; margin-top: 10px; background-color: var(--brand-color); color: white; border: none; border-radius: 3px; font-size: 16px; cursor: pointer; }
        .auth-switch { text-align: center; color: var(--brand-color); cursor: pointer; font-size: 14px; margin-top: 10px; }
    </style>
</head>
<body class="theme-dark">
    
    <div id="auth-screen">
        <form id="auth-form">
            <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h2>
            <input type="text" id="auth-username" placeholder="–ò–º—è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" required>
            <input type="password" id="auth-password" placeholder="–ü–∞—Ä–æ–ª—å" required>
            <input type="text" id="auth-avatar" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –ê–≤–∞—Ç–∞—Ä (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
            <button type="submit" id="auth-button">–í–æ–π—Ç–∏</button>
            <p id="auth-switch-text" class="auth-switch">
                <small>–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é</small>
            </p>
            <div id="auth-message" style="color: red; margin-top: 10px;"></div>
        </form>
    </div>

    <div id="app-container" style="display: none;">

        <aside id="server-list">
            <div class="server-icon" style="background-color: var(--brand-color);">C</div>
            <div class="server-icon" id="theme-icon" style="background-color: var(--bg-dark); font-size: 24px;">üí°</div>
        </aside>

        <aside id="friends-channels-panel">
            <h2 style="font-size: 18px; color: white;">ChaoticCord</h2>
            
            <h3>–ö–ê–ù–ê–õ–´</h3>
            <ul id="channel-list-container" style="list-style: none; padding: 0;"></ul>
            <button id="create-channel-btn" style="width: 100%; margin-top: 10px; background: var(--online-color); color: white; border: none; padding: 5px; border-radius: 3px;">+ –°–æ–∑–¥–∞—Ç—å –ö–∞–Ω–∞–ª</button>
            
            <h3>–î–†–£–ó–¨–Ø</h3>
            <ul id="friends-list-container" style="list-style: none; padding: 0;"></ul>
            
            <h3>–ó–ê–ü–†–û–°–´</h3>
            <ul id="friend-requests-container" style="list-style: none; padding: 0;"></ul>

            <input type="text" id="friend-request-input" placeholder="–î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞ –ø–æ –∏–º–µ–Ω–∏" class="modal-input" style="width: calc(100% - 10px); background: var(--bg-medium); margin-top: 10px;">
            <button id="send-request-btn" class="modal-button" style="width: 100%; margin-top: 5px; background: #388647;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ó–∞–ø—Ä–æ—Å</button>
            
            <div id="user-profile-bar">
                <img id="my-avatar" class="avatar" src="" alt="Avatar">
                <div style="flex-grow: 1;">
                    <strong id="my-username"></strong>
                    <div style="color: var(--text-secondary); font-size: 12px;">#ID</div>
                </div>
            </div>
        </aside>

        <main id="chat-area">
             <header>
                # <strong id="current-channel-name">general</strong>
            </header>
            <div id="messages-container">
                </div>
            
            <form id="form" action="">
                <div id="form-inner">
                    <input id="input" autocomplete="off" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ –≤ #general..." />
                    <button>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
            </form>
        </main>

        <aside id="user-list">
            <h3 id="online-users-count">–û–ù–õ–ê–ô–ù ‚Äî 0</h3>
            <ul id="online-users-list" style="list-style: none; padding: 0;">
                </ul>
        </aside>

    </div>

    <div id="profile-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('profile-modal')">&times;</span>
            <h2 id="modal-profile-title">–ü—Ä–æ—Ñ–∏–ª—å</h2>
            <div style="text-align: center; margin-bottom: 20px;">
                <img id="modal-avatar" class="avatar" style="width: 80px; height: 80px; margin: 10px;" src="" alt="Avatar">
                <h3 id="modal-username"></h3>
                <p id="modal-status" style="color: var(--online-color);"></p>
            </div>
            
            <div id="my-profile-settings" style="border-top: 1px solid var(--bg-darker); padding-top: 15px;">
                <h4>–ò–∑–º–µ–Ω–∏—Ç—å –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h4>
                <input type="text" id="new-username-input" placeholder="–ù–æ–≤–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" class="modal-input">
                <input type="text" id="new-avatar-input" placeholder="–ù–æ–≤–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –∞–≤–∞—Ç–∞—Ä" class="modal-input">
                <button class="modal-button" id="update-profile-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ò–∑–º–µ–Ω–µ–Ω–∏—è</button>
            </div>
        </div>
    </div>
    
    <div id="create-channel-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('create-channel-modal')">&times;</span>
            <h2>–°–æ–∑–¥–∞—Ç—å –ö–∞–Ω–∞–ª</h2>
            <input type="text" id="new-channel-name-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, test-channel)" class="modal-input">
            <button class="modal-button" id="submit-create-channel">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
    </div>
    
    <div id="theme-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('theme-modal')">&times;</span>
            <h2>–°–º–µ–Ω–∞ –¢–µ–º—ã</h2>
            <button class="modal-button" onclick="setTheme('dark')" style="background-color: #1e1f22;">–¢–µ–º–Ω–∞—è –¢–µ–º–∞</button>
            <button class="modal-button" onclick="setTheme('light')" style="background-color: #ffffff; color: #2e3338; border: 1px solid #ddd; margin-top: 10px;">–°–≤–µ—Ç–ª–∞—è –¢–µ–º–∞</button>
        </div>
    </div>


    <script src="/socket.io/socket.io.js"></script>
    <script>
        // --- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ ---
        const API_URL = window.location.origin;
        let token = localStorage.getItem('token');
        let currentUserId = localStorage.getItem('userId');
        let currentUsername = localStorage.getItem('username');
        let currentAvatar = localStorage.getItem('avatar') || '/img/default_chaos.png';
        let currentChannelId = 1; 
        let isRegisterMode = false;
        let socket; 
        let onlineUsers = {}; 

        // --- –≠–ª–µ–º–µ–Ω—Ç—ã GUI ---
        const authScreen = document.getElementById('auth-screen');
        const authForm = document.getElementById('auth-form');
        const authSwitchText = document.getElementById('auth-switch-text');
        const authButton = document.getElementById('auth-button');
        const authMessage = document.getElementById('auth-message');
        const authAvatarInput = document.getElementById('auth-avatar');

        const appContainer = document.getElementById('app-container');
        const messagesContainer = document.getElementById('messages-container');
        const form = document.getElementById('form');
        const input = document.getElementById('input');
        
        const userProfileBar = document.getElementById('user-profile-bar');
        const myUsernameEl = document.getElementById('my-username');
        const myAvatarEl = document.getElementById('my-avatar');
        
        const onlineUsersList = document.getElementById('online-users-list');
        const onlineUsersCount = document.getElementById('online-users-count');

        const channelListContainer = document.getElementById('channel-list-container');
        const currentChannelName = document.getElementById('current-channel-name');
        const createChannelBtn = document.getElementById('create-channel-btn');
        const submitCreateChannel = document.getElementById('submit-create-channel');
        const newChannelNameInput = document.getElementById('new-channel-name-input');
        
        const friendsListContainer = document.getElementById('friends-list-container');
        const friendRequestsContainer = document.getElementById('friend-requests-container');
        const sendRequestBtn = document.getElementById('send-request-btn');
        const friendRequestInput = document.getElementById('friend-request-input');

        // –ú–æ–¥–∞–ª—ã
        const profileModal = document.getElementById('profile-modal');
        const updateProfileBtn = document.getElementById('update-profile-btn');
        const newUsernameInput = document.getElementById('new-username-input');
        const newAvatarInput = document.getElementById('new-avatar-input');
        const themeIcon = document.getElementById('theme-icon');
        const themeModal = document.getElementById('theme-modal');
        
        // --- 0. –¢–ï–ú–´ –ò –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê ---

        function setTheme(theme) {
            document.body.className = `theme-${theme}`;
            localStorage.setItem('theme', theme);
        }
        
        if (localStorage.getItem('theme')) {
            setTheme(localStorage.getItem('theme'));
        } else {
             setTheme('dark');
        }

        themeIcon.addEventListener('click', () => {
            document.getElementById('theme-modal').style.display = 'block';
        });

        function openModal(id, userId = currentUserId) {
            if (id === 'profile-modal') {
                loadProfileData(userId);
            }
            document.getElementById(id).style.display = 'block';
        }

        function closeModal(id) {
             document.getElementById(id).style.display = 'none';
        }
        
        userProfileBar.addEventListener('click', () => openModal('profile-modal'));
        createChannelBtn.addEventListener('click', () => openModal('create-channel-modal'));


        // --- 1. –õ–û–ì–ò–ö–ê –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò ---
        
        function toggleAuthMode() {
            isRegisterMode = !isRegisterMode;
            authButton.textContent = isRegisterMode ? '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è' : '–í–æ–π—Ç–∏';
            authSwitchText.innerHTML = isRegisterMode ? '<small>–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –í—Ö–æ–¥</small>' : '<small>–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é</small>';
            authAvatarInput.style.display = isRegisterMode ? 'block' : 'none';
        }
        authSwitchText.addEventListener('click', toggleAuthMode);
        
        function updateGUI() {
            myUsernameEl.textContent = currentUsername;
            myAvatarEl.src = currentAvatar;
        }

        authForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = document.getElementById('auth-username').value;
            const password = document.getElementById('auth-password').value;
            const avatar = document.getElementById('auth-avatar').value.trim();
            
            const endpoint = isRegisterMode ? '/api/register' : '/api/login';
            
            try {
                const response = await fetch(API_URL + endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, avatar: avatar || null })
                });
                
                const data = await response.json();
                
                if (response.ok && !isRegisterMode) {
                    token = data.token;
                    currentUserId = data.userId;
                    currentUsername = data.username;
                    currentAvatar = data.avatar;

                    localStorage.setItem('token', token);
                    localStorage.setItem('userId', currentUserId);
                    localStorage.setItem('username', currentUsername);
                    localStorage.setItem('avatar', currentAvatar);
                    
                    authScreen.style.display = 'none';
                    appContainer.style.display = 'grid';
                    updateGUI();
                    connectSocket(); 
                    
                } else if (response.ok && isRegisterMode) {
                    authMessage.textContent = '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ.';
                    authMessage.style.color = 'var(--online-color)';
                    toggleAuthMode();
                    
                } else {
                    authMessage.textContent = data.message || '–û—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
                    authMessage.style.color = 'red';
                }
            } catch (error) {
                authMessage.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞.';
                authMessage.style.color = 'red';
            }
        });

        if (token) {
            authScreen.style.display = 'none';
            appContainer.style.display = 'grid';
            updateGUI();
            connectSocket(); 
        }

        // --- 2. –õ–û–ì–ò–ö–ê SOCKET.IO –ò –ß–ê–¢–ê ---
        
        function connectSocket() {
            socket = io(API_URL);
            
            socket.on('connect', () => {
                socket.emit('authenticate', token);
            });
            
            socket.on('newMessage', displayMessage);
            
            socket.on('messageHistory', (history) => {
                messagesContainer.innerHTML = ''; 
                history.forEach(msg => displayMessage(msg, true)); 
                messagesContainer.scrollTop = messagesContainer.scrollHeight; 
            });
            
            // –ö–∞–Ω–∞–ª—ã
            socket.on('initialChannels', (data) => {
                renderChannels(data.channels, data.activeChannelId);
                currentChannelId = data.activeChannelId;
            });
            socket.on('channelChanged', (newId) => {
                currentChannelId = newId;
                const activeChannel = document.querySelector(`.channel-item[data-id="${newId}"]`);
                if (activeChannel) {
                    currentChannelName.textContent = activeChannel.textContent.trim().substring(1);
                }
            });
            socket.on('newChannelCreated', (channel) => {
                 addChannelToGUI(channel);
            });


            // –î—Ä—É–∑—å—è –∏ –°—Ç–∞—Ç—É—Å
            socket.on('initialRelations', renderRelations);
            socket.on('initialOnlineUsers', (users) => {
                users.forEach(user => {
                    if (user.id != currentUserId) {
                        onlineUsers[user.id] = { username: user.username, status: 'online' };
                    }
                });
                renderOnlineList();
            });
            socket.on('userStatusUpdate', updateOnlineUsers);
            socket.on('newFriendRequest', displayFriendRequest);
            
            socket.on('friendAccepted', (username) => {
                alert(`${username} –ø—Ä–∏–Ω—è–ª –≤–∞—à –∑–∞–ø—Ä–æ—Å –≤ –¥—Ä—É–∑—å—è!`);
                socket.emit('reSyncRelations'); 
            });
            socket.on('reSyncRelations', renderRelations); 
            
            socket.on('requestError', (message) => { alert(`–û—à–∏–±–∫–∞: ${message}`); });
            socket.on('requestSuccess', (message) => { alert(`–£—Å–ø–µ—à–Ω–æ: ${message}`); });
        }

        form.addEventListener('submit', function(e) {
            e.preventDefault(); 
            if (input.value.trim() && socket) {
                socket.emit('chat message', { content: input.value });
                input.value = '';
            }
        });
        
        function displayMessage(data, isHistory = false) {
            if (!isHistory && data.channelId && data.channelId != currentChannelId) return; 
             
            const messageEl = document.createElement('div');
            messageEl.classList.add('message');
            
            const time = new Date(data.timestamp).toLocaleTimeString(); 

            messageEl.innerHTML = `
                <img class="avatar" src="${data.avatar}" onclick="openModal('profile-modal', ${data.user_id})">
                <div class="message-content">
                    <div>
                        <strong>${data.username}</strong>
                        <span class="timestamp">${time}</span>
                    </div>
                    <div class="text">${data.content}</div>
                </div>
            `;
            
            messagesContainer.appendChild(messageEl);
            if (!isHistory) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        // --- 3. –ö–ê–ù–ê–õ–´ ---
        
        function renderChannels(channels, activeId) {
            channelListContainer.innerHTML = '';
            channels.forEach(channel => addChannelToGUI(channel, activeId));
        }

        function addChannelToGUI(channel, activeId = currentChannelId) {
            // –£–¥–∞–ª–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π, –µ—Å–ª–∏ –µ—Å—Ç—å (–¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)
            document.querySelector(`.channel-item[data-id="${channel.id}"]`)?.remove();
            
            const li = document.createElement('li');
            li.className = `channel-item ${channel.id == activeId ? 'active' : ''}`;
            li.textContent = `# ${channel.name}`;
            li.dataset.id = channel.id;
            li.addEventListener('click', () => joinChannel(channel.id));
            channelListContainer.appendChild(li);
        }

        function joinChannel(channelId) {
            if (channelId == currentChannelId) return;
            
            document.querySelectorAll('.channel-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`.channel-item[data-id="${channelId}"]`).classList.add('active');
            
            currentChannelName.textContent = document.querySelector(`.channel-item[data-id="${channelId}"]`).textContent.trim().substring(1);

            if (socket) {
                socket.emit('joinChannel', channelId);
            }
        }
        
        submitCreateChannel.addEventListener('click', () => {
             const name = newChannelNameInput.value.trim();
             if (name) {
                 socket.emit('createChannel', name);
                 closeModal('create-channel-modal');
                 newChannelNameInput.value = '';
             }
        });
        

        // --- 4. –ü–†–û–§–ò–õ–¨ –ò –ù–ê–°–¢–†–û–ô–ö–ò ---
        
        async function loadProfileData(userId) {
            const isMyProfile = userId == currentUserId;
            
            document.getElementById('my-profile-settings').style.display = isMyProfile ? 'block' : 'none';

            try {
                const response = await fetch(`${API_URL}/api/profile/${userId}`);
                const user = await response.json();
                
                document.getElementById('modal-profile-title').textContent = isMyProfile ? '–ú–æ–π –ü—Ä–æ—Ñ–∏–ª—å' : '–ü—Ä–æ—Ñ–∏–ª—å –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
                document.getElementById('modal-avatar').src = user.avatar;
                document.getElementById('modal-username').textContent = user.username;
                document.getElementById('modal-status').textContent = user.status === 'online' ? '–û–Ω–ª–∞–π–Ω' : '–û—Ñ—Ñ–ª–∞–π–Ω';
                document.getElementById('modal-status').style.color = user.status === 'online' ? 'var(--online-color)' : 'var(--offline-color)';

                if (isMyProfile) {
                    newUsernameInput.value = user.username;
                    newAvatarInput.value = user.avatar;
                }
            } catch (error) {
                 alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è.');
            }
        }
        
        updateProfileBtn.addEventListener('click', async () => {
            const newUsername = newUsernameInput.value.trim();
            const newAvatar = newAvatarInput.value.trim();
            
            try {
                const response = await fetch(`${API_URL}/api/update_profile`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify({ newUsername, newAvatar })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(data.message);
                    
                    if (data.username) { // –ï—Å–ª–∏ –∏–º—è –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
                        currentUsername = data.username;
                        localStorage.setItem('username', currentUsername);
                        token = data.token; // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω
                        localStorage.setItem('token', token);
                    }
                    if (newAvatar) {
                        currentAvatar = newAvatar;
                        localStorage.setItem('avatar', currentAvatar);
                    }
                    
                    updateGUI();
                    closeModal('profile-modal');
                    // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–º–µ–Ω–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –∏ —Å–ø–∏—Å–∫–∞—Ö
                    socket.disconnect(); 
                    connectSocket(); 
                    
                } else {
                    alert(data.message || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è.');
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è.');
            }
        });

        // --- 5. –î–†–£–ó–¨–Ø –ò –°–¢–ê–¢–£–° ---
        
        sendRequestBtn.addEventListener('click', () => {
             const recipientUsername = friendRequestInput.value.trim();
             if (socket && recipientUsername) {
                 socket.emit('sendFriendRequest', { recipientUsername });
                 friendRequestInput.value = '';
             }
        });

        function renderRelations(relations) {
            friendsListContainer.innerHTML = '';
            friendRequestsContainer.innerHTML = '';

            relations.forEach(rel => {
                if (rel.id == currentUserId) return; 

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å (–¥–ª—è —Å–ø–∏—Å–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤)
                const isPendingRequestToMe = rel.status === 'pending' 
                                            // –í SQL –∑–∞–ø—Ä–æ—Å–µ –º—ã –≤—ã–±–∏—Ä–∞–µ–º ID, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ —Ä–∞–≤–µ–Ω —Ç–µ–∫—É—â–µ–º—É
                                            // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å "pending", –∏ –º—ã –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å —ç—Ç–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞, —Ç–æ —ç—Ç–æ –∫ –Ω–∞–º
                                            // –ü—Ä–æ—Å—Ç–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞: –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å pending, —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ —ç—Ç–æ –∫ –Ω–∞–º.
                                            // –ë–æ–ª–µ–µ —Ç–æ—á–Ω–∞—è –ª–æ–≥–∏–∫–∞: –Ω—É–∂–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ 'senderId' –≤ relations. 
                                            ? true : false;
                

                if (rel.status === 'accepted') {
                    // –î—Ä—É–∑—å—è
                    const li = document.createElement('li');
                    li.classList.add('friend-item');
                    li.innerHTML = `<span class="status-dot ${onlineUsers[rel.id] ? 'online' : 'offline'}"></span> ${rel.username}`;
                    friendsListContainer.appendChild(li);
                } else if (rel.status === 'pending' && isPendingRequestToMe) {
                    // –ó–∞–ø—Ä–æ—Å—ã –≤ –¥—Ä—É–∑—å—è
                    displayFriendRequest({ senderId: rel.id, senderUsername: rel.username });
                }
            });
        }
        
        function displayFriendRequest(data) {
            let existingLi = document.getElementById(`request-${data.senderId}`);
            if (existingLi) return; 

            const li = document.createElement('li');
            li.id = `request-${data.senderId}`; 
            li.innerHTML = `
                <div class="request-item friend-item">
                    ${data.senderUsername}
                    <button class="action-button" onclick="acceptRequest('${data.senderId}')">–ü—Ä–∏–Ω—è—Ç—å</button>
                    <button class="action-button reject" onclick="rejectRequest('${data.senderId}')">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                </div>
            `;
            friendRequestsContainer.prepend(li);
        }

        function acceptRequest(senderId) {
            if (socket) {
                socket.emit('acceptFriendRequest', { senderId });
                document.getElementById(`request-${senderId}`)?.remove();
            }
        }
        
        function rejectRequest(senderId) {
            if (socket) {
                socket.emit('rejectFriendRequest', { senderId });
                document.getElementById(`request-${senderId}`)?.remove();
            }
        }

        function updateOnlineUsers(data) {
            if (data.userId == currentUserId) return; 

            if (data.status === 'online') {
                onlineUsers[data.userId] = { username: data.username, status: 'online' };
            } else if (data.status === 'offline') {
                delete onlineUsers[data.userId];
            }
            
            renderOnlineList();
            renderRelations(socket.relations || []); // –í—ã–∑—ã–≤–∞–µ–º —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –¥—Ä—É–∑–µ–π –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
        }

        function renderOnlineList() {
            onlineUsersList.innerHTML = '';
            const usersArray = Object.values(onlineUsers).filter(u => u.username !== currentUsername);
            
            usersArray.forEach(user => {
                const li = document.createElement('li');
                li.classList.add('friend-item');
                li.innerHTML = `<span class="status-dot online"></span> ${user.username}`;
                onlineUsersList.appendChild(li);
            });
            
            onlineUsersCount.textContent = `–û–ù–õ–ê–ô–ù ‚Äî ${usersArray.length}`;
        }
    </script>
</body>
</html>