<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeoCord Messenger</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body class="theme-dark">

    <div id="app-container">
        <div id="friends-channels-panel">
            <input type="text" id="friend-search-input" placeholder="Найти друга или начать DM..." />

            <div class="friend-list-header">
                <span id="tab-friends" class="active" onclick="showFriendList('friends')">
                    <i class="fas fa-user-friends"></i>Друзья (<span id="friends-count">0</span>)
                </span>
                <span id="tab-requests" onclick="showFriendList('requests')">
                    <i class="fas fa-bell"></i>Запросы (<span id="requests-count">0</span>)
                </span>
            </div>

            <div id="dm-section">
                </div>

            <div id="user-profile-bar" onclick="openSettingsModal()">
                <img id="profile-avatar" class="avatar" src="/img/anon_blue.png" alt="Avatar">
                <div style="margin-right: auto;">
                    <strong id="profile-username">Загрузка...</strong>
                </div>
                <div class="status-indicator"></div>
            </div>
        </div>

        <div id="chat-area">
            <header>
                <span id="chat-header">Выберите друга для чата</span>
            </header>
            
            <div id="messages-container">
                <p style="text-align: center; color: var(--text-sub); margin-top: 50px;">Для начала, авторизуйтесь.</p>
            </div>

            <form id="form">
                <div id="form-inner">
                    <input id="input" autocomplete="off" placeholder="Отправить сообщение..." disabled />
                    <button>Отправить</button>
                </div>
            </form>
        </div>
    </div>

    <div id="auth-modal" class="modal" style="display: block;">
        <div class="modal-content">
            <span class="close" onclick="closeModal('auth-modal')">&times;</span>
            <h2 id="auth-title" style="text-align: center;">Вход</h2>
            <p id="auth-error-message" style="color: var(--danger-color); text-align: center;"></p>

            <form id="auth-form" onsubmit="handleAuth(event)">
                <input type="text" id="auth-username" class="modal-input" placeholder="Имя пользователя" required>
                <input type="password" id="auth-password" class="modal-input" placeholder="Пароль" required>
                
                <div id="avatar-upload-container" style="display: none;">
                    <label for="register-avatar-file" class="file-input-container">
                        <i class="fas fa-camera"></i> Выберите аватар (PNG/JPG, макс 2MB)
                    </label>
                    <input type="file" id="register-avatar-file" accept="image/*" style="display: none;">
                    <p id="file-name-display" style="font-size: 12px; color: var(--text-sub);"></p>
                </div>

                <button id="auth-button" class="modal-button">Войти</button>
            </form>
            <div class="auth-switch" onclick="switchAuthMode()">Перейти к регистрации</div>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div style="width: 200px; padding: 30px 0 30px 30px; background-color: var(--bg-tertiary);">
                <h3 style="margin-top: 0; color: var(--text-main); font-weight: 700;">Настройки</h3>
                <div id="settings-menu">
                    <div class="setting-item active" data-content="my-account">Мой аккаунт</div>
                    <div class="setting-item" data-content="appearance">Внешний вид</div>
                    <div class="setting-item" data-content="admin-panel" style="display: none;">Админ-панель</div>
                    <div class="setting-item logout-item" onclick="handleLogout()">Выйти</div>
                </div>
            </div>

            <div id="settings-content" style="flex-grow: 1;">
                <span class="close" onclick="closeModal('settings-modal')">&times;</span>

                <div id="my-account-content" class="setting-page">
                    <h2>Мой аккаунт</h2>
                    <p style="color: var(--text-sub); margin-bottom: 25px;">Здесь вы можете изменить свое имя пользователя и аватар.</p>
                    
                    <form id="update-profile-form" onsubmit="handleProfileUpdate(event)">
                        <label for="update-username" style="font-size: 13px; color: var(--text-sub); font-weight: 600;">Имя пользователя</label>
                        <input type="text" id="update-username" class="modal-input" placeholder="Новое имя пользователя" style="width: 100%;" required>
                        
                        <label for="update-avatar-file" style="font-size: 13px; color: var(--text-sub); font-weight: 600; margin-top: 15px; display: block;">Аватар</label>
                        <label for="update-avatar-file" class="file-input-container">
                            <i class="fas fa-camera"></i> Выберите новый аватар
                        </label>
                        <input type="file" id="update-avatar-file" accept="image/*" style="display: none;">
                        <p id="update-file-name-display" style="font-size: 12px; color: var(--text-sub);"></p>

                        <button type="submit" class="modal-button">Сохранить изменения</button>
                    </form>

                    <h3 style="color: var(--danger-color); margin-top: 40px;">Опасная зона</h3>
                    <button class="modal-button" style="background-color: var(--danger-color); width: auto;" onclick="confirmDeleteAccount()">Удалить аккаунт</button>
                </div>

                <div id="appearance-content" class="setting-page" style="display: none;">
                    <h2>Внешний вид</h2>
                    <p style="color: var(--text-sub);">Выберите одну из доступных тем.</p>
                    
                    <div style="display: flex; gap: 15px; margin-top: 20px;">
                        <div class="theme-option active-theme" data-theme="dark" onclick="setTheme('dark')">
                            <i class="fas fa-moon"></i>
                            Тёмная
                        </div>
                        <div class="theme-option" data-theme="light" onclick="setTheme('light')">
                            <i class="fas fa-sun"></i>
                            Светлая
                        </div>
                        <div class="theme-option" data-theme="custom" onclick="setTheme('custom')">
                            <i class="fas fa-palette"></i>
                            Синяя
                        </div>
                    </div>
                </div>

                <div id="admin-panel-content" class="setting-page" style="display: none;">
                    <h2>Админ-панель</h2>
                    <p style="color: var(--text-sub);">Выполняйте административные команды.</p>
                    <form id="admin-form" onsubmit="handleAdminCommand(event)">
                        <label for="admin-command" style="font-size: 13px; color: var(--text-sub); font-weight: 600;">Команда (например, listusers, block testuser, announce Привет всем)</label>
                        <input type="text" id="admin-command-input" class="modal-input" placeholder="Введите команду" style="width: 100%;" required>
                        <button type="submit" class="modal-button" style="background-color: var(--danger-color);">Выполнить</button>
                    </form>
                    <pre id="admin-output" style="background-color: var(--input-bg); padding: 10px; border-radius: 4px; margin-top: 20px; color: var(--text-main); white-space: pre-wrap; font-size: 14px;"></pre>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // --- Configuration ---
        const API_URL = '/';
        const messagesContainer = document.getElementById('messages-container');
        const dmSection = document.getElementById('dm-section');
        const chatHeader = document.getElementById('chat-header');
        
        let socket;
        let authMode = 'login';
        let currentUserId;
        let currentUsername;
        let currentAvatar;
        let currentUserIsAdmin = false;
        let activeChat = { id: 0, isDM: true, friendId: null }; 
        let currentFriends = {}; // { userId: { username, avatar, channelId } }
        let currentRequests = {}; // { userId: { username, avatar } }
        let currentToken = localStorage.getItem('jwtToken');

        // --- Utility Functions ---

        function createElement(tag, className = '', textContent = '') {
            const el = document.createElement(tag);
            if (className) el.className = className;
            if (textContent) el.textContent = textContent;
            return el;
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
            document.getElementById('auth-error-message').textContent = '';
        }

        function openModal(id) {
            document.getElementById(id).style.display = 'block';
        }

        // --- Authentication & Initialization ---

        function switchAuthMode() {
            authMode = authMode === 'login' ? 'register' : 'login';
            document.getElementById('auth-title').textContent = authMode === 'login' ? 'Вход' : 'Регистрация';
            document.getElementById('auth-button').textContent = authMode === 'login' ? 'Войти' : 'Зарегистрироваться';
            document.querySelector('.auth-switch').textContent = authMode === 'login' ? 'Перейти к регистрации' : 'Перейти к входу';
            document.getElementById('avatar-upload-container').style.display = authMode === 'register' ? 'block' : 'none';
            document.getElementById('file-name-display').textContent = '';
        }

        async function handleAuth(event) {
            event.preventDefault();
            const username = document.getElementById('auth-username').value;
            const password = document.getElementById('auth-password').value;
            const fileInput = document.getElementById('register-avatar-file');
            const errorMessage = document.getElementById('auth-error-message');
            errorMessage.textContent = '';
            
            const formData = new FormData();
            formData.append('username', username);
            formData.append('password', password);
            if (authMode === 'register' && fileInput.files[0]) {
                formData.append('avatar', fileInput.files[0]);
            }

            try {
                const endpoint = authMode === 'login' ? '/api/login' : '/api/register';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    body: authMode === 'login' ? JSON.stringify({ username, password }) : formData,
                    headers: authMode === 'login' ? { 'Content-Type': 'application/json' } : {}
                });

                const data = await response.json();

                if (response.ok) {
                    if (authMode === 'login') {
                        localStorage.setItem('jwtToken', data.token);
                        currentToken = data.token;
                        initializeUI(data);
                        closeModal('auth-modal');
                    } else {
                        errorMessage.textContent = 'Регистрация успешна! Теперь войдите.';
                        switchAuthMode();
                    }
                } else {
                    errorMessage.textContent = data.message || `Ошибка ${authMode}.`;
                }
            } catch (error) {
                errorMessage.textContent = `Ошибка сети: ${error.message}`;
            }
        }

        function initializeUI(userData) {
            currentUserId = userData.userId;
            currentUsername = userData.username;
            currentAvatar = userData.avatar;
            currentUserIsAdmin = userData.isAdmin;
            
            document.getElementById('profile-username').textContent = currentUsername;
            document.getElementById('profile-avatar').src = currentAvatar;
            document.getElementById('input').disabled = false;
            
            // Show Admin Panel option if admin
            document.querySelector('[data-content="admin-panel"]').style.display = currentUserIsAdmin ? 'block' : 'none';

            connectSocket();
        }

        function handleLogout() {
            localStorage.removeItem('jwtToken');
            currentToken = null;
            location.reload(); 
        }

        // --- Chat and Socket Logic ---

        function displayMessage(msg, isHistory = false) {
            const item = createElement('div', 'message');
            
            const avatarImg = createElement('img', 'avatar');
            avatarImg.src = msg.avatar;
            item.appendChild(avatarImg);
            
            const contentDiv = createElement('div', 'message-content');
            
            const header = createElement('div');
            const isAnnouncement = msg.username === 'SYSTEM ANNOUNCEMENT';
            const usernameStyle = isAnnouncement ? 'color: var(--danger-color); font-weight: bold;' : '';
            
            header.innerHTML = `<strong style="${usernameStyle}">${msg.username}</strong> <span class="timestamp">${new Date(msg.timestamp).toLocaleTimeString('ru-RU')}</span>`;
            contentDiv.appendChild(header);
            
            const text = createElement('p', '', msg.content);
            contentDiv.appendChild(text);
            
            item.appendChild(contentDiv);
            messagesContainer.appendChild(item);
            
            if (!isHistory) {
                scrollToBottom(); 
            }
        }

        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight; 
        }

        function connectSocket() {
            if (socket) { socket.disconnect(); }
            socket = io(API_URL);

            socket.on('connect', () => {
                if (currentToken) {
                    socket.emit('authenticate', currentToken);
                } else {
                    openModal('auth-modal');
                }
            });

            socket.on('initialData', (data) => {
                currentFriends = data.friends.reduce((acc, f) => { acc[f.userId] = f; return acc; }, {});
                currentRequests = data.pendingRequests.reduce((acc, r) => { acc[r.userId] = r; return acc; }, {});
                
                activeChat.id = data.activeChatId;
                if (activeChat.id !== 0) {
                     // Determine friendId based on channel members (for DM)
                     const friendKeys = Object.keys(currentFriends);
                     for (let friendId of friendKeys) {
                         if (currentFriends[friendId].channelId === activeChat.id) {
                            activeChat.friendId = currentFriends[friendId].userId;
                            chatHeader.textContent = `@${currentFriends[friendId].username}`;
                            break;
                         }
                     }
                } else {
                    chatHeader.textContent = `Выберите друга для чата`;
                }
                
                // Обновляем UI на основе текущей активной вкладки
                const activeTab = document.querySelector('.friend-list-header span.active').id.replace('tab-', '');
                updateFriendListUI(activeTab);
            });
            
            // НОВЫЙ ОБРАБОТЧИК ДЛЯ ТОЧЕЧНОГО ОБНОВЛЕНИЯ ДРУЗЕЙ
            socket.on('friendAdded', (friendData) => {
                 currentFriends[friendData.userId] = friendData;
                 
                 // Если текущая вкладка - друзья, обновим UI
                 if (document.getElementById('tab-friends').classList.contains('active')) {
                     updateFriendListUI('friends');
                 } else {
                     document.getElementById('friends-count').textContent = Object.keys(currentFriends).length;
                 }
                 
                 // Если это первое добавление друга, и чат пуст, присоединяемся к новому чату
                 if (activeChat.id === 0) {
                     joinChat(friendData.channelId, friendData.userId, friendData.username);
                 }
            });

            socket.on('newMessage', (msg) => {
                if (msg.channelId === activeChat.id) {
                    displayMessage(msg);
                }
            });

            socket.on('messageHistory', (history) => {
                messagesContainer.innerHTML = ''; 
                if (history.length === 0) {
                     messagesContainer.innerHTML = `<p style="text-align: center; color: var(--text-sub); margin-top: 50px;">Начните разговор!</p>`;
                }
                history.forEach(msg => displayMessage(msg, true)); 
                scrollToBottom(); 
            });

            socket.on('systemAnnouncement', (msg) => {
                // Display system message globally
                displayMessage(msg); 
            });

            socket.on('requestError', (message) => {
                alert(`Ошибка: ${message}`);
            });
            
            socket.on('requestSuccess', (message) => {
                if (document.getElementById('admin-panel-content').style.display !== 'none') {
                     document.getElementById('admin-output').textContent = message;
                } else {
                     console.log('Success:', message);
                }
            });
            
            socket.on('friendRequestReceived', (request) => {
                currentRequests[request.userId] = request;
                // Обновляем список запросов, если на вкладке "Запросы", или только счетчик
                 if (document.getElementById('tab-requests').classList.contains('active')) {
                     updateFriendListUI('requests');
                 } else {
                     document.getElementById('requests-count').textContent = Object.keys(currentRequests).length;
                 }
                alert(`Новый запрос в друзья от ${request.username}!`);
            });
            
            socket.on('accountDeleted', () => {
                 alert('Ваш аккаунт был удален.');
                 handleLogout();
            });

            socket.on('disconnect', () => {
                console.log('Socket disconnected.');
                if (currentToken) {
                    messagesContainer.innerHTML = `<p style="text-align: center; color: var(--danger-color); margin-top: 50px;">Соединение потеряно. Переподключение...</p>`;
                }
            });
        }

        // --- Friend List & DM Logic ---
        
        function showFriendList(tab) {
            document.getElementById('tab-friends').classList.remove('active');
            document.getElementById('tab-requests').classList.remove('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
            updateFriendListUI(tab);
        }

        function updateFriendListUI(tab) {
            dmSection.innerHTML = '';
            document.getElementById('friends-count').textContent = Object.keys(currentFriends).length;
            document.getElementById('requests-count').textContent = Object.keys(currentRequests).length;

            if (tab === 'friends') {
                const friendsArray = Object.values(currentFriends);
                if (friendsArray.length === 0) {
                    dmSection.innerHTML = `<p style="color: var(--text-sub); text-align: center; margin-top: 20px;">Нет друзей. Отправьте запрос!</p>`;
                } else {
                    friendsArray.forEach(friend => {
                        const item = createElement('div', 'friend-item');
                        item.setAttribute('data-id', friend.userId);
                        item.onclick = () => joinChat(friend.channelId, friend.userId, friend.username);
                        
                        const isActive = activeChat.id === friend.channelId;
                        if (isActive) item.classList.add('active');
                        
                        item.innerHTML = `
                            <img class="avatar" src="${friend.avatar}" alt="Avatar">
                            <span>${friend.username}</span>
                        `;
                        dmSection.appendChild(item);
                    });
                }
            } else if (tab === 'requests') {
                const requestsArray = Object.values(currentRequests);
                if (requestsArray.length === 0) {
                    dmSection.innerHTML = `<p style="color: var(--text-sub); text-align: center; margin-top: 20px;">Нет входящих запросов.</p>`;
                } else {
                    requestsArray.forEach(request => {
                        const item = createElement('div', 'friend-item');
                        item.style.flexWrap = 'wrap';
                        item.innerHTML = `
                            <img class="avatar" src="${request.avatar}" alt="Avatar">
                            <span style="flex-grow: 1;">${request.username}</span>
                            <button onclick="handleFriendRequest(${request.userId}, 'accept', event)" style="margin-left: 10px; background: var(--online-color); color: white; border: none; padding: 5px 8px; border-radius: 4px; cursor: pointer;"><i class="fas fa-check"></i></button>
                            <button onclick="handleFriendRequest(${request.userId}, 'reject', event)" style="margin-left: 5px; background: var(--danger-color); color: white; border: none; padding: 5px 8px; border-radius: 4px; cursor: pointer;"><i class="fas fa-times"></i></button>
                        `;
                        dmSection.appendChild(item);
                    });
                }
            }
        }
        
        function joinChat(channelId, friendId, friendUsername) {
            if (activeChat.id === channelId) return;
            
            // Update active item in the list
            document.querySelectorAll('.friend-item').forEach(el => el.classList.remove('active'));
            const friendItem = document.querySelector(`.friend-item[data-id="${friendId}"]`);
            if (friendItem) friendItem.classList.add('active');
            
            chatHeader.textContent = `@${friendUsername}`;
            activeChat.id = channelId;
            activeChat.friendId = friendId;
            
            socket.emit('joinChat', { newId: channelId, isDM: true });
        }
        
        function handleFriendRequest(userId, action, event) {
            event.stopPropagation(); // Prevent item click (joinChat)
            socket.emit('handleFriendRequest', { userId: userId, action: action });
            
            // Обновляем локальный список запросов сразу для быстрого UX
            delete currentRequests[userId];
            updateFriendListUI('requests');
        }

        // --- Message Submission ---
        document.getElementById('form').onsubmit = function(e) {
            e.preventDefault();
            const input = document.getElementById('input');
            const content = input.value.trim();
            
            if (!content) return;
            if (activeChat.id === 0) {
                alert('Выберите друга для отправки сообщения!');
                return;
            }
            
            // Check for admin command prefix
            if (content.toLowerCase().startsWith('/admin ') && currentUserIsAdmin) {
                 const command = content.substring(7); // Remove "/admin "
                 const parts = command.split(' ');
                 const cmd = parts[0].toLowerCase();
                 let targetUsername = null;
                 let message = null;
                 
                 if (cmd === 'block' || cmd === 'unblock') {
                      targetUsername = parts[1];
                 } else if (cmd === 'announce') {
                      message = command.substring(command.toLowerCase().indexOf('announce') + 'announce'.length).trim();
                 }
                 
                 socket.emit('adminCommand', { command: cmd, targetUsername: targetUsername, message: message });
            } else {
                 // Regular message
                 socket.emit('chat message', { content: content });
            }
            
            input.value = '';
        };

        // --- Settings Logic ---
        
        function openSettingsModal() {
            openModal('settings-modal');
            
            // Set current values in the update form
            document.getElementById('update-username').value = currentUsername;
            document.getElementById('update-file-name-display').textContent = 'Текущий аватар: не меняется';

            // Show default tab
            document.querySelector('.setting-item[data-content="my-account"]').click();
        }

        // Tab switching in settings
        document.querySelectorAll('.setting-item').forEach(item => {
            item.onclick = function() {
                document.querySelectorAll('.setting-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                
                document.querySelectorAll('.setting-page').forEach(page => page.style.display = 'none');
                
                const contentId = item.getAttribute('data-content');
                if (contentId) {
                    document.getElementById(contentId + '-content').style.display = 'block';
                }
            };
        });
        
        // Profile update submission
        async function handleProfileUpdate(event) {
            event.preventDefault();
            const newUsername = document.getElementById('update-username').value;
            const fileInput = document.getElementById('update-avatar-file');
            
            const formData = new FormData();
            formData.append('newUsername', newUsername);
            if (fileInput.files[0]) {
                 formData.append('avatar', fileInput.files[0]);
            }
            
            try {
                const response = await fetch('/api/update-profile', {
                    method: 'POST',
                    body: formData,
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });

                const data = await response.json();

                if (response.ok) {
                    alert('Профиль обновлен! ' + (data.message || ''));
                    // Re-authenticate to update token and refresh UI with new data
                    socket.emit('authenticate', currentToken);
                    closeModal('settings-modal');
                } else {
                    alert('Ошибка обновления профиля: ' + (data.message || response.statusText));
                }
            } catch (error) {
                alert(`Ошибка сети: ${error.message}`);
            }
        }
        
        function confirmDeleteAccount() {
             if (confirm("Вы уверены, что хотите удалить свой аккаунт? Это действие необратимо!")) {
                 deleteAccount();
             }
        }
        
        async function deleteAccount() {
             try {
                const response = await fetch('/api/delete-account', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                     alert('Аккаунт успешно удален.');
                     handleLogout();
                } else {
                     alert('Ошибка удаления аккаунта: ' + (data.message || response.statusText));
                }
             } catch (error) {
                 alert(`Ошибка сети: ${error.message}`);
             }
        }
        
        // Theme Logic
        function setTheme(themeName) {
            document.body.className = `theme-${themeName}`;
            localStorage.setItem('theme', themeName);
            document.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('active-theme'));
            document.querySelector(`.theme-option[data-theme="${themeName}"]`).classList.add('active-theme');
        }
        
        const storedTheme = localStorage.getItem('theme') || 'dark';
        setTheme(storedTheme);
        
        // File name display update
        document.getElementById('register-avatar-file').addEventListener('change', function() {
            document.getElementById('file-name-display').textContent = this.files.length ? this.files[0].name : '';
        });
        document.getElementById('update-avatar-file').addEventListener('change', function() {
            document.getElementById('update-file-name-display').textContent = this.files.length ? this.files[0].name : 'Текущий аватар: не меняется';
        });

        // Initial check for token
        if (currentToken) {
             document.getElementById('auth-modal').style.display = 'none';
             connectSocket();
        } else {
             openModal('auth-modal');
        }

        // Global modal closing
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = "none";
            }
        };

        // Command processing for Admin Panel
        document.getElementById('admin-form').onsubmit = function(e) {
            e.preventDefault();
            const fullCommand = document.getElementById('admin-command-input').value.trim();
            const parts = fullCommand.split(' ');
            const cmd = parts[0].toLowerCase();
            let targetUsername = parts[1] || '';
            let message = '';
            
            if (cmd === 'announce') {
                 // Extract message after "announce"
                 message = fullCommand.substring(fullCommand.toLowerCase().indexOf('announce') + 'announce'.length).trim();
            }
            
            socket.emit('adminCommand', { command: cmd, targetUsername: targetUsername, message: message });
            document.getElementById('admin-command-input').value = '';
        };

    </script>
</body>
</html>